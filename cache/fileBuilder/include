if(fcf.module({name:"fcf:NRender/NDetails/Helper.js",module:function(){function setArg(a_taskInfo,a_argName,a_value){var normPath=fcf.normalizeObjectAddress(a_argName),ptr=fcf.resolveEx(a_taskInfo.args,normPath,!0);ptr.object[ptr.key]=a_value,delete a_taskInfo.srcArgs[normPath],a_taskInfo.processedArgs[normPath]=!0}return{appendChildInfo:function(a_dstArgs,a_srcArgs,a_chlidInfo){a_chlidInfo&&a_chlidInfo.childs&&a_srcArgs&&a_chlidInfo.childs[a_srcArgs.fcfCP]&&(fcf.append(a_dstArgs,a_chlidInfo.childs[a_srcArgs.fcfCP].args),a_dstArgs.fcfChildsArgs=a_chlidInfo.childs[a_srcArgs.fcfCP])},callHook:function(a_template,a_name,a_taskInfo){if(a_template.hooks&&a_template.hooks[a_name]&&(fcf.setContext(a_taskInfo.context),"function"==typeof a_template.hooks[a_name])){var result=a_template.hooks[a_name].call(a_template.hooks,a_taskInfo);("undefined"!=typeof Promise&&result instanceof Promise||result instanceof fcf.Actions)&&a_taskInfo.actions.exec(function(a_act){result.then(function(result){a_act.complete()}).catch(function(a_error){a_act.error(a_error)})})}},callHookBeforeArgument:function(a_template,a_argName,a_taskInfo){if(a_template.hooks&&a_template.hooks.hooksBeforeArgument&&a_template.hooks.hooksBeforeArgument[a_argName]&&(fcf.setContext(a_taskInfo.context),a_template.hooks||"function"==typeof a_template.hooks.hooksBeforeArgument[a_argName])){var result=a_template.hooks.hooksBeforeArgument[a_argName].call(a_template.hooks,a_taskInfo);"undefined"!=typeof Promise&&result instanceof Promise||result instanceof fcf.Actions?a_taskInfo.actions.exec(function(a_act){result.then(function(result){a_act.complete()}).catch(function(a_error){a_act.error(a_error)})}):void 0!==result&&setArg(a_taskInfo,a_argName,result)}},callHookAfterArgument:function(a_template,a_argName,a_taskInfo){if(a_template.hooks&&a_template.hooks.hooksAfterArgument&&a_template.hooks.hooksAfterArgument[a_argName]&&(fcf.setContext(a_taskInfo.context),a_template.hooks||"function"==typeof a_template.hooks.hooksAfterArgument[a_argName])){var result=a_template.hooks.hooksAfterArgument[a_argName].call(a_template.hooks,a_taskInfo);"undefined"!=typeof Promise&&result instanceof Promise||result instanceof fcf.Actions?a_taskInfo.actions.exec(function(a_act){result.then(function(result){a_act.complete()}).catch(function(a_error){a_act.error(a_error)})}):void 0!==result&&setArg(a_taskInfo,a_argName,result)}},callHookProgramableArgument:function(a_template,a_argName,a_taskInfo){if(a_template.hooks&&a_template.hooks.hooksProgramableArgument&&a_template.hooks.hooksProgramableArgument[a_argName]&&(fcf.setContext(a_taskInfo.context),"function"==typeof a_template.hooks.hooksProgramableArgument[a_argName])){var result=a_template.hooks.hooksProgramableArgument[a_argName].call(a_template.hooks,a_taskInfo);"undefined"!=typeof Promise&&result instanceof Promise||result instanceof fcf.Actions?a_taskInfo.actions.exec(function(a_act){result.then(function(result){setArg(a_taskInfo,a_argName,result),a_act.complete()}).catch(function(a_error){a_act.error(a_error)})}):void 0!==result&&setArg(a_taskInfo,a_argName,result)}}}}}),fcf.module({name:"fcf:NRender/TaskInfo.js",dependencies:["fcf:NRender/NDetails/Helper.js"],module:function(helper){var NRender=fcf.prepareObject(fcf,"NRender");return NRender.TaskInfo=function(a_options){fcf.append(this,a_options),this._callMap={},this.setArg=function(a_path,a_value){var normPath=fcf.normalizeObjectAddress(a_path);this.owner._callHookBeforeArgument(this,normPath);var ptr=fcf.resolveEx(this.args,a_path,!0);ptr.object[ptr.key]=a_value,delete this.srcArgs[normPath],this.processedArgs[normPath]=!0,this.owner._callHookAfterArgument(this,normPath)},this.render=function(a_options){var fcfCP=this._getCallPosition(),inheritArgs={};helper.appendChildInfo(inheritArgs,{fcfCP:fcfCP},this.args.fcfChildsArgs);var args=fcf.append({},a_options.args,inheritArgs,{fcfParent:this.args.fcfId,fcfCP:fcfCP});return this._render.render({theme:this.state.theme,template:a_options.template,args:args,state:this.state,request:this.request,reqursion:!0,onResult:a_options.onResult}).then(a_template=>{delete a_template.state})},this._getCallPosition=function(){var stackArr=(new Error).stack.split("\n"),strInfo=fcf.trim(-1==stackArr[0].indexOf(":")?stackArr[3]:stackArr[2],[" ",")"]),callPostition="",dc=0;if(strInfo.length){this._callMap;for(var charCode0="0".charCodeAt(0),charCode9="9".charCodeAt(0),i=strInfo.length-1;i>=0;--i){var charCode=strInfo.charCodeAt(i);if(!(charCode>=charCode0&&charCode<=charCode9)&&++dc>=2){callPostition=strInfo.substr(i+1);break}}}var cp="hook:"+callPostition;return cp in this._callMap||(this._callMap[cp]=0),cp+="-"+ ++this._callMap[cp]}},NRender.TaskInfo}}),fcf.module({name:"fcf:NFSQL/NFilter/Filter.js",dependencies:[],module:function(){var NFilter=fcf.prepareObject(fcf,"NFSQL.NFilter");return NFilter._filters={},NFilter.getFilter=function(a_type){return a_type in NFilter._filters?NFilter._filters[a_type].filter:NFilter._defaultFilter},NFilter.Filter=function(a_options){this._type=a_options?a_options.type:{type:"text"},this.comparisons={},this.enableOrder=!0,this.validate=function(a_description,a_dstErrors){},this.friendly=function(a_view,a_value){return a_value.toString()},this.availableComparison=function(a_operation,a_mode){return this.comparisons[a_mode]?void 0!=fcf.find(this.comparisons[a_mode],a_operation):!!this.comparisons["*"]&&void 0!=fcf.find(this.comparisons["*"],a_operation)},this.comparison=function(a_cmpType,a_left,a_right){switch(a_cmpType){case"=":return a_left==a_right;case"<":return a_left<a_right;case">":return a_left>a_right;case"<=":return a_left<=a_right;case">=":return a_left>=a_right;case"like":var search=fcf.replaceAll(a_right,"%",".*"),re=new RegExp(search,"gi");return-1!=fcf.str(a_left).search(re)}},this.getRealFields=function(a_projection,a_fieldAlias){let rf=fcf.clone(a_projection.mapFields[a_fieldAlias]);return rf.alias==a_projection.key&&(rf.primary=!0),[rf]},this.equalRealFields=function(a_left,a_right){let res=a_left.field==a_right.field&&a_left.type==a_right.type&&a_left.min==a_right.min&&a_left.max==a_right.max;if(!a_left.primary&&!a_right.primary){res&=(!!a_left.notEmpty||!!a_left.notNull)==(!!a_right.notEmpty||!!a_right.notNull),res&=!!a_left.unique==!!a_right.unique}return!!res},this.getDependences=function(a_projection,a_fieldAliasOrType){return[]},this.checkStructure=function(a_projection,a_field){},this.validate=function(a_description,a_dstErrors){},this.processOutputField=function(a_taskInfo,a_info){},this.processWhereField=function(a_taskInfo,a_info){},this.processUpdateField=function(a_taskInfo,a_info){},this.processInsertField=function(a_taskInfo,a_info){},this.processDeleteField=function(a_taskInfo,a_info){}},NFilter._defaultFilter=new NFilter.Filter,NFilter.Filter}}),fcf.module({name:"fcf:NServer/PackageHandler.js",dependencies:[],module:function(){var NServer=fcf.prepareObject(fcf,"NServer");return NServer.PackageHandler=function(){this.initialize=function(){},this.install=function(a_cb){}},NServer.PackageHandler}}),fcf.isServer())var modPath=require("path"),modFs=require("fs");if(fcf.addException("ERROR_PACKAGE_NOT_FOUND","Package '${{1}}$' was not found"),fcf.module({name:"fcf:NServer/NDetails/Package.js",dependencies:["fcf:NFSQL/NFilter/Filter.js","fcf:NServer/PackageHandler.js"],module:function(Filter,DefaultPackageHandler){var NDetails=fcf.prepareObject(fcf,"NServer.NDetails");return NDetails.Package=function(a_settings){this._info={html:{include:{}}},this._packageName=a_settings.package,this._dependecies=[],fcf.empty(a_settings.info)||fcf.append(this._info,a_settings.info),this.getInfo=function(){return this._info},this.getName=function(){return this._packageName},this.initialize=function(){let self=this,packageData=void 0,reverseProjections=[],installModules=[],packageHandler=void 0,clModules=[],clTypes=[],clFunctionsModules=[],clFunctionsTypes=[],dirPack=void 0,modName=void 0,packFilePath=void 0;return fcf.application.getPackages()[a_settings.package]?fcf.actions():fcf.actions().append(function(a_act){if(!(packFilePath=self._findPackagePath(a_settings.sources,a_settings.package+"."+a_settings.extension)))throw new fcf.Exception("ERROR_PACKAGE_NOT_FOUND",[a_settings.package]);dirPack=modPath.dirname(packFilePath),modName=a_settings.package,a_settings.modPrefix&&(modName=a_settings.modPrefix+modName.charAt(0).toUpperCase()+modName.substr(1)),self._packageName=modName;var urlPack="fcfpackages/"+modName;fcf.addModule(modName,dirPack,urlPack),fcf.load({path:packFilePath,onResult:function(a_error,a_data){a_error?a_act.error(a_error):(packageData=fcf.scriptExecutor.parse(a_data,{},packFilePath,0),a_act.complete())}})}).append(function(a_act){new fcf.Actions({onError:a_act}).each(packageData.dependencies,function(a_subact,a_key,a_dependencies){let pack=new NDetails.Package({application:a_settings.application,configuration:a_settings.configuration,package:a_dependencies,sources:a_settings.sources,extension:a_settings.extension});fcf.actions(pack.initialize()).then(function(){a_settings.application.appendPackage(pack),a_subact.complete()}).catch(function(a_error){a_subact.error(a_error)})}).execAC(function(){a_act.complete()})}).append(function(a_act){try{if(self._mergeOptions(packageData),!1!==a_settings.configuration&&a_settings.configuration.appendPackageInfo(a_settings.package,packageData,self.isTheme),"object"==typeof packageData.aliases)for(k in packageData.aliases)fcf.application.appendTemplateAlias(k,packageData.aliases[k]);if("object"==typeof packageData.views)for(k in packageData.views)fcf.application.appendViewAlias(k,packageData.views[k]);if("object"==typeof packageData.filters){var modules=[],types=[];for(type in packageData.filters)modules.push(packageData.filters[type]),types.push(type);clModules=modules,clTypes=types}if("object"==typeof packageData.functions){modules=[],types=[];for(type in packageData.functions)modules.push(packageData.functions[type]),types.push(type);clFunctionsModules=modules,clFunctionsTypes=types}if(Array.isArray(packageData.publicFileDirectories))for(var i=0;i<packageData.publicFileDirectories.length;++i)if("object"==typeof packageData.publicFileDirectories[i]){var relativeUrl=packageData.publicFileDirectories[i].relativeUrl,path=packageData.publicFileDirectories[i].path,sourcePath="";sourcePath=-1!==path.indexOf("@")?path:-1===path.indexOf(":")?modName+":"+path:path,relativeUrl=fcf.empty(relativeUrl)?path:relativeUrl;fcf.empty(relativeUrl);fcf.application.getRouter().append([{uri:fcf.empty(relativeUrl)?"fcfpackages/"+modName+"/"+packageData.publicFileDirectories[i].path+"/*":"fcfpackages/"+modName+"/"+relativeUrl+"/*",controller:"fcf:NServer/NControllers/File.js",source:sourcePath}])}if(fcf.application.getRouter().append([{uri:"fcfpackages/"+modName+"/"+modName+"."+a_settings.extension,controller:"fcf:NServer/NControllers/File.js",source:modName+":"+modName+"."+a_settings.extension}]),Array.isArray(packageData.publicFiles))for(i=0;i<packageData.publicFiles.length;++i)if("object"==typeof packageData.publicFiles[i]){relativeUrl=packageData.publicFiles[i].relativeUrl;fcf.application.getRouter().append([{uri:fcf.empty(relativeUrl)?"fcfpackages/"+modName+"/"+packageData.publicFiles[i].path:"fcfpackages/"+modName+"/"+relativeUrl,controller:"fcf:NServer/NControllers/File.js",source:modName+":"+packageData.publicFiles[i].path}])}if(Array.isArray(packageData.routers))for(i=0;i<packageData.routers.length;++i)"object"==typeof packageData.routers[i]&&fcf.application.getRouter().append([packageData.routers[i]]);let projectionFiles=[];if(Array.isArray(packageData.projectionDirectories)&&!fcf.empty(packageData.projectionDirectories)){let clReadDirectory=a_path=>{a_path=0==a_path.indexOf("/")?a_path:-1==a_path.indexOf(":")?self._packageName+":"+a_path:a_path,a_path=fcf.getPath(a_path);var files=modFs.readdirSync(a_path);for(var key in files){let fpath=a_path+"/"+files[key],fstat=void 0;try{fstat=modFs.statSync(fpath)}catch(e){continue}fstat.isDirectory()?clReadDirectory(fpath):"projection"==fcf.getExtension(fpath)&&projectionFiles.push(fpath)}};for(let i=0;i<packageData.projectionDirectories.length;++i)clReadDirectory(packageData.projectionDirectories[i])}if(Array.isArray(packageData.projections)&&!fcf.empty(packageData.projections)){let projections=[];fcf.each(packageData.projections,(a_key,a_path)=>{a_path=0==a_path.indexOf("/")?a_path:-1==a_path.indexOf(":")?self._packageName+":"+a_path:a_path,projections.push(a_path)}),fcf.append(projectionFiles,projections)}fcf.empty(projectionFiles)||fcf.application.getProjections().loadFromFiles(projectionFiles),fcf.each(fcf.application.getProjections().getProjections(),function(a_alias,a_projection){a_projection.dbSync&&reverseProjections.push(a_projection)})}catch(except){return void a_act.error(except)}a_act.complete()}).append(function(a_act){fcf.empty(clModules)?a_act.complete():fcf.require(clModules,function(){for(var i=0;i<clTypes.length;++i){let constr=fcf.getModule(clModules[i]).result;fcf.NDetails._filters[clTypes[i]]=new constr}a_act.complete()})}).exec(a_act=>{fcf.application.getSettings().disableUpdateProjection?a_act.complete():fcf.require(["fcf:NFSQL/NDetails/DBBuilder.js"],DBBuilder=>{new DBBuilder(fcf.application.getStorage(),reverseProjections).build().then(()=>{a_act.complete()}).catch(e=>{a_act.error(e)})})}).append(function(a_act){fcf.empty(clFunctionsModules)?a_act.complete():fcf.require(clFunctionsModules,function(){fcf.each(clFunctionsTypes,function(a_key,a_type){fcf.NFSQL.NFunction.setFunction(a_type,fcf.getModule(clFunctionsModules[a_key]))}),a_act.complete()})}).append(function(a_act){!1,fcf.application.selectSystemVariables("fcf:installModules",{hideErrors:["ER_NO_SUCH_TABLE","ERROR_MEMDB_TABLE_NOT_EXISTS"]},function(a_error,a_variables){a_error?a_act.complete():(installModules=Array.isArray(a_variables["fcf:installModules"])?a_variables["fcf:installModules"]:[],a_act.complete())})}).append(function(a_act){modPath.dirname(packFilePath);var modHandlerName=modName;"fcf"==modName&&(modHandlerName="fcfModule");var isModuleExist=modFs.existsSync(fcf.getPath(modName+":"+modName+".js",!0));fcf.requireEx([modName+":"+modHandlerName+".js"],{showError:!1},function(a_error,PackageHandler){isModuleExist&&a_error&&console.error(a_error,PackageHandler),packageHandler=new(PackageHandler=PackageHandler||DefaultPackageHandler),fcf.application.getSettings().disableSys||void 0!==fcf.find(installModules,modName)?a_act.complete():(fcf.log.log("FCF","Installing package "+modName+"..."),fcf.actions(packageHandler.install()).then(function(){fcf.log.log("FCF","Installing package "+modName+" is completed"),installModules.push(modName),fcf.application.updateSystemVariables({"fcf:installModules":installModules},function(a_error){a_error&&fcf.log.err("FCF",a_error),a_act.complete()})}).catch(function(a_error){a_act.error(a_error)}))})}).append(function(a_act){packageHandler?fcf.actions(packageHandler.initialize()).then(function(){a_act.complete()}).catch(function(a_error){a_act.error(a_error)}):a_act.complete()})},this._mergeOptions=function(a_data){for(var key in a_data)if("publicFileDirectories"==key)this._info[key]||(this._info[key]={}),fcf.append(this._info[key],a_data[key]);else if("html"==key){if(!a_data[key].include)continue;this._info[key]||(this._info[key]={}),this._info[key].include||(this._info[key].include={}),fcf.append(this._info[key],a_data[key])}else"aliases"==key?(this._info[key]||(this._info[key]={}),fcf.append(this._info[key],a_data[key])):this._info[key]=a_data[key]},this._findPackagePath=function(a_paths,a_fileName){function clFind(a_path,a_fileName){var statDir=modFs.lstatSync(a_path);if(!statDir||statDir.isDirectory()){for(var files=modFs.readdirSync(a_path),i=0;i<files.length;++i){var filePath=modPath.join(a_path,files[i]);if(!modFs.lstatSync(filePath).isDirectory()&&a_fileName==files[i])return filePath}for(i=0;i<files.length;++i){filePath=modPath.join(a_path,files[i]);if(modFs.lstatSync(filePath).isDirectory()){var res=clFind(filePath,a_fileName);if(res)return res}}}}for(var i=a_paths.length-1;i>=0;--i){var res=clFind(fcf.getPath(a_paths[i]),a_fileName);if(res)return res}}},NDetails.Package}}),fcf.module({name:"fcf:NTheme/Theme.js",dependencies:["fcf:NServer/NDetails/Package.js"],module:function(Package){var NRender=fcf.prepareObject(fcf,"NRender");return NRender.Theme=function(a_initializeOptions){var initializeOptions=fcf.append({},a_initializeOptions,{extension:"theme",setConfiguration:!1}),self=this;Package.call(this,initializeOptions),this.isTheme=!0,this._aliases={},this._views={parts:{},all:{},cur:{}},fcf.prepareObject(this.getInfo(),"html.include"),this.clientInitialize=function(){};var parentInitialize=this.initialize;this.initialize=function(){return fcf.isServer()?this._serverInitialize():this._clientInitialize()},this.getDecor=function(){return this._info.decor},this._clientInitialize=function(){this.setAliases(initializeOptions.configuration.getConfiguration().aliases),initializeOptions.info.aliases&&this.setAliases(initializeOptions.info.aliases),this.setViews(initializeOptions.configuration.getConfiguration().views),initializeOptions.info.views&&this.setViews(initializeOptions.info.views)},this._serverInitialize=function(){return parentInitialize.call(this).exec(function(a_act){var extendsNames=Array.isArray(self._info.extends)?self._info.extends:self._info.extends?[self._info.extends]:[],exts=[];new fcf.Actions({onError:function(a_error){a_act.error(a_error)}}).each(extendsNames,function(a_subact,a_key,a_item){if(fcf.application.getThemes().getThemes[a_item])exts.push(fcf.application.getThemes().getThemes[a_item]),a_subact.complete();else{var subTheme=new NRender.Theme({actions:a_initializeOptions.actions,package:a_item,sources:a_initializeOptions.sources,extension:a_initializeOptions.extension,configuration:fcf.application.getConfiguration()});subTheme.initialize().then(function(){exts.push(subTheme),a_subact.complete()}).catch(function(a_error){a_subact.error(a_error)})}}).execAC(function(){self._applyExtends(exts);var packs=fcf.application.getPackages();for(var pm in packs)"object"==typeof packs[pm].aliases&&self.setAliases(packs[pm].aliases);"object"==typeof self._info.aliases&&self.setAliases(self._info.aliases),"object"==typeof self._info.views&&self.setViews(self._info.views),self._appendIncludes(),a_act.complete()})})},this._applyExtends=function(a_extends){var info=this.getInfo();info.html||(info.html={}),info.html.include||(info.html.include={});var originalInclude={},originalDecor={};fcf.each(a_extends,function(a_key,a_extend){var einfo=a_extend.getInfo();einfo.html&&einfo.html.include&&fcf.append(originalInclude,einfo.html.include),einfo.decor&&fcf.append(originalDecor,einfo.decor)}),fcf.append(originalInclude,info.html.include),fcf.append(originalDecor,info.decor),info.html.include=originalInclude,info.decor=originalDecor},this.setViews=function(a_objectViews){for(var part in a_objectViews)for(var view in a_objectViews[part])this.setView(part,view,a_objectViews[part][view])},this.setView=function(a_part,a_view,a_template){for(var partArr=a_part.split("."),currentParts=this._views,i=0;i<partArr.length;++i){if("*"==partArr[i])return void(currentParts.all[a_view]=a_template);partArr[i]in currentParts.parts||(currentParts.parts[partArr[i]]={parts:{},cur:{},all:{}}),currentParts=currentParts.parts[partArr[i]]}currentParts.cur[a_view]=a_template},this.getView=function(a_part,a_type){if("object"==typeof a_type){var view=fcf.buildModeObject(a_part,a_type,"usage");if(view.template)return{template:view.template,found:!0};a_type=a_type.type}for(var partArr=a_part.split("."),currentParts=this._views,result=void 0,i=0;i<partArr.length;++i){if(a_type in currentParts.all&&(result={template:currentParts.all[a_type],found:!0}),!(partArr[i]in currentParts.parts)){currentParts=void 0;break}currentParts=currentParts.parts[partArr[i]]}if(currentParts&&a_type in currentParts.cur?result={template:currentParts.cur[a_type],found:!0}:currentParts&&a_type in currentParts.all&&(result={template:currentParts.all[a_type],found:!0}),result)return result;var inheritanceMode=fcf.application.getInheritanceModes()[a_part];return inheritanceMode?this.getView(inheritanceMode,a_type):{template:"@controls:text",found:!1}},this.setAliases=function(a_objectAliases){for(var alias in a_objectAliases)this.setAlias(alias,a_objectAliases[alias])},this.setAlias=function(a_alias,a_uri){var alias=a_alias.split("&");alias=alias.length>1?alias[1]:alias[0],this._aliases[alias]=a_uri},this.getAliases=function(){return this._aliases},this.resolveAlias=function(a_path){if("@"!=a_path.charAt(0))return a_path;var subpart=a_path.split("+")[1],alias=(a_path=a_path.split("+")[0]).substr(1),result=alias in this._aliases?this._aliases[alias]:a_path;return subpart&&(result+="+"+subpart),result},this._appendIncludes=function(){var packs=fcf.application.getPackages();for(var packName in packs)if(!packs[packName].isTheme){var inf=packs[packName].getInfo();inf.html&&inf.html.include&&fcf.append(this.getInfo().html.include,inf.html.include)}}},NRender.Theme}}),fcf.isServer())var fs=require("fs");if(fcf.addException("ERROR_PACKAGE_NOT_FOUND","Theme ${{theme}}$ not found"),fcf.module({name:"fcf:NTheme/Themes.js",dependencies:["fcf:NTheme/Theme.js"],module:function(Theme){var NRender=fcf.prepareObject(fcf,"NRender");return NRender.Themes=function(a_initializeOptions){var self=this;this._themes={},this._aliases={},this._views={},this._defaultTheme=a_initializeOptions.defaultTheme?a_initializeOptions.defaultTheme:"defaultTheme",this.getTheme=function(a_name,a_safeMode){var result=fcf.empty(a_name)?this._themes[this._defaultTheme]:this._themes[a_name]?this._themes[a_name]:a_safeMode?this._themes[this._defaultTheme]:void 0,name=a_name||this._defaultTheme;if(!result&&!a_safeMode)throw new fcf.Exception("ERROR_PACKAGE_NOT_FOUND",{theme:name});return result},this.getThemes=function(){return this._themes},this.getDefaultThemeName=function(){return this._defaultTheme},this.setDefaultThemeName=function(a_defaultThemeName){this._defaultTheme=a_defaultThemeName},this.attachTheme=function(a_name,a_theme){this._themes[a_name]=a_theme},this.initialize=function(){var themes=void 0;return fcf.actions().exec(function(a_act){self._findThemes(function(a_error,a_themes){a_error?a_act.error(a_error):(themes=a_themes,a_act.complete())})}).each(function(){return themes},function(a_act,a_key,a_themeName){var theme=new Theme({package:a_themeName,sources:a_initializeOptions.sources,configuration:a_initializeOptions.configuration});self._themes[a_themeName]=theme,fcf.actions(theme.initialize()).then(function(){a_act.complete()}).catch(function(a_error){a_act.error(a_error)})}).then(function(){for(var key in self._themes)self._themes[key].setAliases(self._aliases),self._themes[key].setViews(self._views)})},this.setAliases=function(a_aliases){for(var key in this._themes)this._themes[key].setAliases(a_aliases);fcf.append(this._aliases,a_aliases)},this.setViews=function(a_views){for(var key in this._themes)this._themes[key].setViews(a_views);for(var key in a_views)this._views[key]||(this._views[key]={}),fcf.append(this._views[key],a_views[key])},this._findThemes=function(a_cb){var themes=[],actions=new fcf.Actions({onComplete:function(){a_cb(void 0,themes)},onError:function(a_error){a_cb(a_error)}});function clReadDir(a_path){a_path=fcf.getPath(a_path),actions.append(function(a_extAct){fs.readdir(a_path,function(a_error,a_items){if(a_error)throw new fcf.Exception("ERROR_TEST_OPEN_DIRECTORY",{directory:a_path});actions.each(a_items,function(a_act,a_key,a_item){var pathFile=a_path+"/"+a_item;if(fs.lstatSync(pathFile).isFile()){if("theme"!=fcf.getExtension(pathFile))return void a_act.complete();themes.push(fcf.getShortFileName(pathFile)),a_act.complete()}else clReadDir(pathFile),a_act.complete()}),a_extAct.complete()})})}if(Array.isArray(a_initializeOptions.sources))for(var i=0;i<a_initializeOptions.sources.length;++i)clReadDir(a_initializeOptions.sources[i]);actions.startup()}},NRender.Themes}}),fcf.module({name:"fcf:NRender/NDetails/ArgsDependecies.js",dependencies:[],module:function(){var NDetails=fcf.prepareObject(fcf,"NRender.NDetails");return NDetails.ArgsDependecies=function(a_options){this.buildOrder=function(a_args){var dependencies={};for(var key in a_args)if(dependencies[key]=[],"object"==typeof a_args[key]){if(a_args[key].tokenize){var deps=this._getTokenizeDependencies(a_args[key]);fcf.append(dependencies[key],deps)}Array.isArray(a_args[key].dependencies)&&fcf.append(dependencies[key],a_args[key].dependencies)}return dependencies=this._normalizeOrderDeps(dependencies)},this._normalizeOrderDeps=function(a_orderDeps){var orderDeps={};for(var key in a_orderDeps){var nkey=fcf.normalizeObjectAddress(key);for(var itemKey in orderDeps[nkey]=[],a_orderDeps[key])orderDeps[nkey].push(fcf.normalizeObjectAddress(a_orderDeps[key][itemKey]))}return orderDeps},this._getTokenizeDependencies=function(a_arg,a_dst){var isRoot=!1;for(var k in void 0===a_dst&&(a_dst={},isRoot=!0),a_arg)if("string"==typeof a_arg[k])for(var keys=fcf.getVariablesString(a_arg[k]),i=0;i<keys.length;++i)a_dst[keys[i]]=!0;else"object"==typeof a_arg[k]&&this._getTokenizeDependencies(a_arg[k],a_dst);if(isRoot){var result=[];for(var k in a_dst)result.push(k);return result}}},NDetails.ArgsDependecies}}),fcf.isServer())var libFS=require("fs");if(fcf.module({name:"fcf:NRender/NDetails/Loader.js",dependencies:["fcf:NRender/NDetails/ArgsDependecies.js"],module:function(ArgsDependecies){var NDetails=fcf.prepareObject(fcf,"NRender.NDetails");fcf.addException("ERROR_RENDER_SERVER_ONLY_TEMPLATE","The '${{template}}$' template can only be rendered on the server"),fcf.addException("ERROR_RENDER_TEMPLATE_NOT_FOUND","Element '${{template}}$' template not found");var innerFileStorage={},innerWatchFiles={};return NDetails.Loader=function(a_options){var self=this;this._options=fcf.append({},a_options),this._argOrderDetector=new ArgsDependecies({}),this.setSettings=function(a_options){fcf.append(this._options,a_options)},this.load=function(a_path,a_state,a_cb){"function"==typeof a_state&&(a_cb=a_state,a_state={theme:fcf.application.getThemes().getTheme("defaultTheme",!0)}),a_path=a_path.split("+")[0];var arrPath=(a_path=a_state.theme.resolveAlias(a_path)).split("+");arrPath[0],arrPath[1];this._loadTemplate(a_path,a_state,a_path).then(function(a_template){a_cb(void 0,a_template)}).catch(function(a_error){a_cb(a_error)})},this._loadTemplate=function(a_path,a_state,a_mainTemplate){a_path=fcf.getPath(a_path);let template=void 0;return fcf.actions().then(()=>innerFileStorage[a_path]?innerFileStorage[a_path]:fcf.load({path:a_path,aliases:a_state.theme.getAliases()}).then(a_data=>(innerFileStorage[a_path]=a_data,fcf.isServer()&&!innerWatchFiles[a_path]&&(innerWatchFiles[a_path]=!0,libFS.watchFile(a_path,{interval:1e3},(a_eventType,a_filename)=>{delete innerFileStorage[a_path]})),a_data))).then(function(a_data){let ov=fcf.NDetails.currentTemplate;fcf.NDetails.currentTemplate=a_mainTemplate,template=self._parseTemplate(a_data,a_path),fcf.NDetails.currentTemplate=ov}).then(function(){return!fcf.isServer()&&template.options.serverOnly?template:fcf.actions().each(template.templates,function(a_act,a_key,a_subTemplate){var hookFileArr=a_path.split(".");hookFileArr.pop(),""!=a_key&&(hookFileArr[hookFileArr.length-1]+="+"+a_key),hookFileArr.push("hooks"),hookFileArr.push("js");var hookFilePath=hookFileArr.join(".");fcf.requireEx([hookFilePath],{showError:!1},function(error,hooks){if(error&&-1!==error.toString().indexOf("SyntaxError"))a_act.error(error);else{if(hooks){var nh={};fcf.each(hooks.hooksProgramableArgument,function(a_key,a_hook){nh[fcf.normalizeObjectAddress(a_key)]=a_hook}),hooks.hooksProgramableArgument=nh;nh={};fcf.each(hooks.hooksBeforeArgument,function(a_key,a_hook){nh[fcf.normalizeObjectAddress(a_key)]=a_hook}),hooks.hooksBeforeArgument=nh;nh={};fcf.each(hooks.hooksAfterArgument,function(a_key,a_hook){nh[fcf.normalizeObjectAddress(a_key)]=a_hook}),hooks.hooksAfterArgument=nh,fcf.append(a_subTemplate.hooks,hooks)}a_act.complete()}})})}).then(function(){return!fcf.isServer()&&template.options.serverOnly?template:template.options.extends?self._loadTemplate(template.options.extends,a_state,a_mainTemplate).then(a_etemplate=>self._inheritance(a_etemplate,template)):template})},this._inheritance=function(a_baseTemplate,a_template){var result={options:{},templates:{}};fcf.append(!0,result.options,a_baseTemplate.options),fcf.append(!0,result.options,a_template.options);var names={};for(var tname in fcf.each(a_template.templates,function(k){names[k]=!0}),fcf.each(a_baseTemplate.templates,function(k){names[k]=!0}),names){result.templates[tname]||(result.templates[tname]={arguments:{},template:{items:[],template:""},hooks:{}});var args=a_baseTemplate.templates[tname]&&a_baseTemplate.templates[tname].arguments?a_baseTemplate.templates[tname].arguments:{};result.templates[tname].arguments=self._normalzieArgs(args);args=a_template.templates[tname]&&a_template.templates[tname].arguments?a_template.templates[tname].arguments:{};if(fcf.append(result.templates[tname].arguments,self._normalzieArgs(args)),a_baseTemplate.templates[tname]&&!fcf.empty(a_baseTemplate.templates[tname].template)&&(result.templates[tname].template=a_baseTemplate.templates[tname].template),a_template.templates[tname]&&!fcf.empty(a_template.templates[tname].template)&&(result.templates[tname].template=a_template.templates[tname].template),a_baseTemplate.templates[tname]&&!fcf.empty(a_baseTemplate.templates[tname].hooks)&&(fcf.append(result.templates[tname].hooks,a_baseTemplate.templates[tname].hooks),result.templates[tname].hooks.prototype||(result.templates[tname].hooks.prototype={}),result.templates[tname].hooks.prototype=a_baseTemplate.templates[tname].hooks),a_template.templates[tname]&&!fcf.empty(a_template.templates[tname].hooks)){fcf.append(result.templates[tname].hooks,a_template.templates[tname].hooks);var dstHooks=result.templates[tname].hooks,srcHooks=dstHooks.prototype;if(srcHooks){if(!fcf.empty(srcHooks.hooksProgramableArgument))for(var key in srcHooks.hooksProgramableArgument)key in dstHooks.hooksProgramableArgument||(dstHooks.hooksProgramableArgument[key]=srcHooks.hooksProgramableArgument[key]);if(!fcf.empty(srcHooks.hooksBeforeArgument))for(var key in srcHooks.hooksBeforeArgument)key in dstHooks.hooksBeforeArgument||(dstHooks.hooksBeforeArgument[key]=srcHooks.hooksBeforeArgument[key]);if(!fcf.empty(srcHooks.hooksAfterArgument))for(var key in srcHooks.hooksAfterArgument)key in dstHooks.hooksAfterArgument||(dstHooks.hooksAfterArgument[key]=srcHooks.hooksAfterArgument[key])}}}return result},this._normalzieArgs=function(a_args){var result={};for(var key in a_args)result[fcf.normalizeObjectAddress(key)]=fcf.append(!0,a_args[key]);return result},this._parseTemplate=function(a_ctxt,a_path){var result={options:{},templates:{}},blocksPositions=[],lstpos=0;do{var blockPositions=this._getBlockPositions(a_ctxt,lstpos);(lstpos=blockPositions.dataEnd)&&blocksPositions.push(blockPositions)}while(lstpos);for(var i=0;i<blocksPositions.length;++i)this._parseBlock(result,a_ctxt,blocksPositions[i],a_path);return result},this._parseBlock=function(a_dst,a_ctxt,a_blockPositions,a_path){let headerLine=a_ctxt.substr(a_blockPositions.headerBeg+3,a_blockPositions.headerEnd-a_blockPositions.headerBeg-3),arrHeaderLine=fcf.splitSpace(headerLine),type=arrHeaderLine[0]?arrHeaderLine[0].toUpperCase():"",name=arrHeaderLine[1]?arrHeaderLine[1]:"";if(a_dst.templates[name]||(a_dst.templates[name]={arguments:{},template:{},hooks:{}}),"OPTIONS"==type){let data=a_ctxt.substr(a_blockPositions.dataBeg,a_blockPositions.dataEnd-a_blockPositions.dataBeg),stringNumber=this._getStringNumber(a_ctxt,a_blockPositions.dataBeg),options=fcf.scriptExecutor.parse(data,{},a_path,stringNumber);fcf.append(a_dst.options,options)}if("ARGUMENTS"==type){let data=a_ctxt.substr(a_blockPositions.dataBeg,a_blockPositions.dataEnd-a_blockPositions.dataBeg),stringNumber=this._getStringNumber(a_ctxt,a_blockPositions.dataBeg),args=fcf.scriptExecutor.parse(data,{},a_path,stringNumber),normalizeArgs={};for(let k in args)normalizeArgs[fcf.normalizeObjectAddress(k)]=args[k];fcf.append(a_dst.templates[name].arguments,normalizeArgs)}else if("TEMPLATE"==type){let content=a_ctxt.substr(a_blockPositions.dataBeg,a_blockPositions.dataEnd-a_blockPositions.dataBeg);a_dst.templates[name].template=this._contentToJS(this._removeLastLF(content)),a_dst.templates[name].template.stringNumber=this._getStringNumber(a_ctxt,a_blockPositions.dataBeg)}},this._getStringNumber=function(a_txt,a_position){void 0===a_position&&(a_position=a_txt.length);let pos=void 0,n=0;for(;;){if(-1==(pos=a_txt.indexOf("\n",void 0!==pos?pos+1:0))||pos>a_position)return n;++n}},this._getBlockPositions=function(a_ctxt,a_start){for(var pos,result={headerBeg:void 0,headerEnd:void 0,dataBeg:void 0,dataEnd:void 0};;)if(-1==(pos=a_ctxt.indexOf("//~",a_start))||0==pos||"\n"==a_ctxt[pos-1]){if(-1==pos)return result;var dpos=pos+3;if(dpos>=a_ctxt.length)return result;for(var epos=dpos;a_ctxt.charCodeAt(epos)>32&&epos<a_ctxt.length;)++epos;if(epos>=a_ctxt.length)return result;if(a_ctxt.substring(dpos,epos).toLowerCase()in{template:!0,options:!0,arguments:!0})break;a_start=epos}else a_start=pos;if(result.headerBeg=pos,-1==result.headerBeg)return result.headerBeg=void 0,result;if(result.headerEnd=a_ctxt.indexOf("\n",pos),-1==result.headerEnd)return result.headerBeg=void 0,result.headerEnd=void 0,result;if(result.dataBeg=result.headerEnd+1>a_ctxt.length?void 0:result.headerEnd+1,void 0===result.dataBeg)return result.headerBeg=void 0,result.headerEnd=void 0,result;for(var lstpos=result.dataBeg;-1!=(pos=a_ctxt.indexOf("//~",lstpos))&&"\n"!=a_ctxt[pos-1];)lstpos=pos;return result.dataEnd=-1!=pos?pos:a_ctxt.length,result},this._removeLastLF=function(a_content){return a_content.length>=2&&"\r"==a_content.charAt(a_content.length-2)&&"\n"==a_content.charAt(a_content.length-1)?a_content.substr(0,a_content.length-2):a_content.length>=1&&"\n"==a_content.charAt(a_content.length-1)?a_content.substr(0,a_content.length-1):a_content},this._contentToJS=function(a_content){for(var items=[],pos=0,startPos=0;-1!=pos;){if(-1!==(pos=a_content.indexOf("{{",pos))&&0!==pos&&"$"==a_content[pos-1])pos-startPos-1&&items.push({type:"content",data:a_content.substr(startPos,pos-startPos-1)}),-1!=(endPos=a_content.indexOf("}}$",pos))?(items.push({type:"variable",data:fcf.trim(a_content.substr(pos+2,endPos-pos-2))}),startPos=pos=endPos+3):pos=-1;else if(-1!==pos&&0!==pos&&"#"==a_content[pos-1]){pos-startPos-1&&items.push({type:"content",data:a_content.substr(startPos,pos-startPos-1)}),-1!=(endPos=a_content.indexOf("}}#",pos))?(items.push({type:"variable",data:fcf.trim(a_content.substr(pos+2,endPos-pos-2))}),startPos=pos=endPos+3):pos=-1}else if(-1!==pos&&0!==pos&&"@"==a_content[pos-1]){pos-startPos-1&&items.push({type:"content",data:a_content.substr(startPos,pos-startPos-1)});let endPos=void 0,fpos=pos,counter=0;for(;;){let startNextBlock=a_content.indexOf("@{{",fpos);if(endPos=a_content.indexOf("}}@",fpos),!counter&&(startNextBlock>endPos||-1==startNextBlock||-1==endPos))break;startNextBlock>endPos?(fpos=endPos+3,++counter):(fpos=startNextBlock+3,--counter)}-1!=endPos?(items.push({type:"calculation",data:fcf.trim(fcf.trim(a_content.substr(pos+2,endPos-pos-2)),[";"])}),startPos=pos=endPos+3):pos=-1}else if(-1!==pos&&0!==pos&&"!"==a_content[pos-1]){pos-startPos-1&&items.push({type:"content",data:a_content.substr(startPos,pos-startPos-1)}),-1!=(endPos=a_content.indexOf("}}!",pos))?(items.push({type:"translate",data:fcf.trim(a_content.substr(pos+2,endPos-pos-2))}),startPos=pos=endPos+3):pos=-1}else if(-1!==pos&&0!==pos&&"%"==a_content[pos-1]){var endPos;pos-startPos-1&&items.push({type:"content",data:a_content.substr(startPos,pos-startPos-1)}),-1!=(endPos=a_content.indexOf("}}%",pos))?(items.push({type:"code",data:a_content.substr(pos+2,endPos-pos-2)}),startPos=pos=endPos+3):pos=-1}else-1==pos?(a_content.length-startPos&&items.push({type:"content",data:a_content.substr(startPos,a_content.length-startPos)}),pos=-1):pos+=2}for(var result="var _2318115_block_env={args: args, route: route, projections: projections, decor: decor};",i=0;i<items.length;++i)if("code"==items[i].type)result+=items[i].data,result+=";";else if("variable"==items[i].type)result+="render.write(fcf.resolve(_2318115_block_env, '"+items[i].data+"' ) );";else if("calculation"==items[i].type)result+="render.write("+items[i].data+");";else if("translate"==items[i].type)result+='render.write(fcf.t("'+fcf.escapeQuotes(items[i].data,void 0,!0)+'", undefined, true));';else if("content"==items[i].type){result+="render.write(_innerfcf_currentTemplateBlocks["+i+"].data);";let lines=this._getStringNumber(items[i].data);for(let i=0;i<lines;++i)result+="\n"}return{items:items,template:result}}},NDetails.Loader}}),fcf.module({name:"fcf:NRender/NDetails/TemplateRender.js",dependencies:[],module:function(){var NDetails=fcf.prepareObject(fcf,"NRender.NDetails"),debugIncludeFiles=["fcf:NRender/NDetails/Helper.js","fcf:NRender/TaskInfo.js","fcf:NFSQL/NFilter/Filter.js","fcf:NServer/PackageHandler.js","fcf:NServer/NDetails/Package.js","fcf:NTheme/Theme.js","fcf:NTheme/Themes.js","fcf:NRender/NDetails/ArgsDependecies.js","fcf:NRender/NDetails/Loader.js","fcf:NRender/NDetails/TemplateRender.js","fcf:NRender/NDetails/TemplateProcessor.js","fcf:NRender/Template.js","fcf:NRender/NDetails/ArgsBuilder.js","fcf:NRender/Render.js","fcf:NFSQL/Projections.js","fcf:NFSQL/NDetails/Errors.js","fcf:NFSQL/NDetails/SingleBuilder.js","fcf:NFSQL/Builder.js","fcf:NFSQL/NDetails/ClientStorage.js","fcf:NFSQL/Storage.js","fcf:NEvent/Error.js","fcf:NServer/Configuration.js","fcf:NClient/LocalData.js","fcf:NClient/Router.js","fcf:NClient/Application.js","fcf:NRender/Wrapper.js"];return NDetails.TemplateRender=function(a_initializeOptions){this.buffer="",this.templates={},this.markerPrefix="<marker c9193820-251d-11ea-bc52-d7f06800af03 ",this.markerSuffix="></marker>",this.markerHeader=this.markerPrefix+"header"+this.markerSuffix,this._callMap={},this.write=function(a_content){this.buffer+=fcf.str(a_content)},this.template=function(a_options,a_args){"string"==typeof a_options&&(a_options={template:a_options,args:a_args});var fcfCP=this._getCallPosition(),templateMarker=this.markerPrefix+fcf.uuid()+this.markerSuffix;a_options.args||(a_options.args={});var newArgs={};for(var k in a_options.args)newArgs[fcf.normalizeObjectAddress(k)]=a_options.args[k];return a_options.args=newArgs,a_options.args=fcf.append({},a_options.args,{fcfCP:fcfCP,fcfParent:a_initializeOptions.args.fcfWrapper?a_initializeOptions.args.fcfId:void 0}),this.templates[templateMarker]=fcf.append(!0,{},{type:"template",options:a_options}),templateMarker},this.view=function(a_options){var fcfCP=this._getCallPosition(),templateMarker=this.markerPrefix+fcf.uuid()+this.markerSuffix;return a_options.args||(a_options.args={}),a_options.args=fcf.append({},a_options.args,{fcfCP:fcfCP,fcfParent:a_initializeOptions.args.fcfWrapper?a_initializeOptions.args.fcfId:void 0}),this.templates[templateMarker]=fcf.append(!0,{},{type:"view",options:a_options}),templateMarker},this.header=function(){return this.templates[this.markerHeader]={type:"header",options:{}},this.markerHeader},this._getCallPosition=function(){var stackArr=(new Error).stack.split("\n"),strInfo=fcf.trim(-1==stackArr[0].indexOf(":")?stackArr[3]:stackArr[2],[" ",")"]),callPostition="",dc=0;if(strInfo.length)for(var charCode0="0".charCodeAt(0),charCode9="9".charCodeAt(0),i=strInfo.length-1;i>=0;--i){var charCode=strInfo.charCodeAt(i);if(!(charCode>=charCode0&&charCode<=charCode9)&&++dc>=2){callPostition=strInfo.substr(i+1);break}}var cp="block:"+callPostition;return cp in this._callMap||(this._callMap[cp]=0),cp+="-"+ ++this._callMap[cp]},this._header=function(){var theme=fcf.application.getThemes().getTheme(a_initializeOptions.args.fcfTheme);theme||(theme=fcf.application.getThemes().getTheme());var result="",themeInfo=theme.getInfo();if(result+="    <style> .fcfwrapper { display: inline; }</style>\n",result+='    <script src="'+fcf.getPath("fcf:fcf.js",!1)+'"><\/script>\n',result+='    <script src="'+fcf.getPath("@url:fcfProjections",!1)+'"><\/script>\n',fcf.getContext().get("debug"))for(var i=0;i<debugIncludeFiles.length;++i){let filePath=fcf.getPath(debugIncludeFiles[i],!1);result+='    <script src="'+filePath+'"><\/script>\n'}else result+='    <script src="/fcfpackages/fcf/include.js"><\/script>\n';result+="    <script>\n";var routeData=a_initializeOptions.request.getRouteData(),route=routeData.route&&routeData.route.data&&routeData.route.data.route?routeData.route.data.route:routeData.path,defaultTheme=a_initializeOptions.state.defaultTheme?a_initializeOptions.state.defaultTheme.getName():void 0;defaultTheme||(defaultTheme=fcf.application.getThemes().getDefaultThemeName());let context=fcf.getContext(),sendContext={};for(var k in context)"safeEnv"!=k&&(sendContext[k]=context[k]);var options={context:sendContext,route:route,clientRenderingMode:"server"==fcf.application.getSettings().clientRenderingMode?"server":"client",defaultTheme:defaultTheme,"fileСaching":fcf.application.getSettings().fileСaching,renderStorage:a_initializeOptions.state.renderStorage};result+="      fcf.application.setSettings("+JSON.stringify(options)+");";var inlineRenderRestore="{renderRestore:{";fcf.each(a_initializeOptions.state.sources,function(a_id,a_control){inlineRenderRestore+='"'+fcf.escapeQuotes(a_id)+'":{',fcf.each(a_control,function(a_key,a_value){if(inlineRenderRestore+='"'+fcf.escapeQuotes(a_key)+'": ',fcf.isArg(a_value)){inlineRenderRestore+='fcf.arg("'+a_value.type+'",';var value=fcf.arg({},a_value);delete value.type,inlineRenderRestore+=JSON.stringify(value),inlineRenderRestore+=")"}else inlineRenderRestore+=JSON.stringify(a_value);inlineRenderRestore+=","}),inlineRenderRestore+="},"}),result+="      fcf.application.setSettings("+(inlineRenderRestore+="}}")+");\n",result+="    <\/script>\n",result+='    <script src="/fcfpackages/fcf/packages.js"><\/script>\n';var includeFilesMap={},includeFiles=[];for(var path in fcf.each(fcf.application.getConfiguration().getConfiguration().html.include,function(a_key,a_path){var path=fcf.getPath(a_path,!1);includeFilesMap[path]||(includeFilesMap[path]=!0,includeFiles.push(path))}),fcf.each(themeInfo.html.include,function(a_key,a_path){var path=fcf.getPath(a_path,!1);includeFilesMap[path]||(includeFilesMap[path]=!0,includeFiles.push(path))}),a_initializeOptions.state.include)path=fcf.getPath(path,!1),includeFilesMap[path]||(includeFilesMap[path]=!0,includeFiles.push(path));return fcf.each(includeFiles,function(a_key,a_path){var ext=fcf.getExtension(a_path);"css"==ext?result+='    <link rel="stylesheet" type="text/css" href="'+a_path+'">\n':"js"==ext&&(result+='    <script src="'+a_path+'"><\/script>\n')}),result}},NDetails.TemplateRender}}),fcf.module({name:"fcf:NRender/NDetails/TemplateProcessor.js",dependencies:["fcf:NRender/NDetails/TemplateRender.js","fcf:NRender/NDetails/Helper.js"],module:function(TemplateRender,helper){var NDetails=fcf.prepareObject(fcf,"NRender.NDetails");return NDetails.TemplateProcessor=function(a_settings){var self=this;this.build=function(a_options){var template=a_options.template.split("+")[0],templateRender=new TemplateRender({request:a_options.request,args:a_options.args,state:a_options.state}),projections=(self._getRenderingBlocks(a_options.template,a_options.rawTemplate,a_options.aliases?a_options.aliases:{}),a_options.projections?a_options.projections:fcf.application.getProjections().getProjections()),decor="object"==typeof a_options.state.theme.getInfo().decor?a_options.state.theme.getInfo().decor:{},aliases="object"==typeof a_options.state.theme.getInfo().aliases?a_options.state.theme.getInfo().aliases:{};fcf.setContext(a_options.context);try{self._renderBlock({render:templateRender,args:a_options.args,sources:a_options.sources,projections:projections,route:a_options.route,decor:decor,aliases:aliases,template:function(a_template,a_args){return render.template({template:a_template,args:a_args})},stringNumber:a_options.rawTemplate.template.stringNumber,_innerfcf_currentTemplate:a_options.rawTemplate.template.template,_innerfcf_currentTemplateBlocks:a_options.rawTemplate.template.items},template)}catch(e){return void a_options.onResult(e)}var result=templateRender.buffer;if(a_options.args.fcfWrapper){var content="<div ";if(content+='fcftemplate="'+a_options.state.theme.resolveAlias(a_options.template)+'" ',content+=" id='"+a_options.args.fcfId+"' ",content+=" class='fcfwrapper "+fcf.str(a_options.args.fcfClass)+"' ",content+=a_options.args.fcfEvntid?" fcfevntid='"+a_options.args.fcfEvntid+"'":"",a_options.args.fcfStyle&&(content+=" style='"+a_options.args.fcfStyle+"' "),"object"==typeof a_options.args.fcfAttributes)for(var k in a_options.args.fcfAttributes)content+=" "+k+'="'+a_options.args.fcfAttributes[k]+'" ';a_options.args.fcfParent&&(content+='fcfparent="'+a_options.args.fcfParent+'" '),a_options.args.fcfAlias&&(content+='fcfalias="'+a_options.args.fcfAlias+'" '),result=content+=">"+result+"</div>"}!function(inlineTemplates){fcf.actions({onError:function(a_error){a_options.onResult(a_error)}}).each(templateRender.templates,function(a_act,a_key,a_templateInfo){var inheritArgs={};if(helper.appendChildInfo(inheritArgs,a_templateInfo.options.args,a_options.args.fcfChildsArgs),a_key!=templateRender.markerHeader)if("template"===a_templateInfo.type){var args=fcf.append({},a_templateInfo.options.args,inheritArgs);"+"==(options=fcf.append({},a_templateInfo.options,{request:a_options.request,route:a_options.route,state:a_options.state,update:a_options.update,context:a_options.context,args:args,reqursion:!0,onResult:function(a_error,a_template){if(a_error)return fcf.log.err("Render",a_error),void a_act.error(a_error);inlineTemplates[a_key]=a_template.content,a_act.complete()}})).template.charAt(0)&&(options.template=a_options.template.split("+")[0]+options.template),a_options.render.render(options)}else if("view"===a_templateInfo.type){var options={args:{}},mode=a_templateInfo.options.mode?a_templateInfo.options.mode:a_templateInfo.options.view&&a_templateInfo.options.view.mode?a_templateInfo.options.view.mode:"read",view=fcf.buildModeObject(mode,a_templateInfo.options.view,"usage");for(var key in fcf.append(options.args,view),fcf.append(options.args,view.templateArgs),a_templateInfo.options)"args"!=key&&(options.args[key]=a_templateInfo.options[key]);fcf.append(options.args,a_templateInfo.options.args),fcf.append(options.args,inheritArgs),options.args.fcfView=a_templateInfo.options.view,"value"in a_templateInfo.options?options.args.value=a_templateInfo.options.value:"value"in a_templateInfo.options.view&&(options.args.value=a_templateInfo.options.view.value),a_templateInfo.options&&a_templateInfo.options.viewArgs&&fcf.append(options.args,a_templateInfo.options.viewArgs);mode=a_templateInfo.options.mode?a_templateInfo.options.mode:"read";var template=a_options.state.theme.getView(mode,a_templateInfo.options.view).template;options=fcf.append(options,{template:template,request:a_options.request,route:a_options.route,state:a_options.state,update:a_options.update,reqursion:!0,onResult:function(a_error,a_template){if(a_error)return fcf.log.err("Render",a_error),void a_act.error(a_error);inlineTemplates[a_key]=a_template.content,a_act.complete()}}),a_options.render.render(options)}else a_act.complete();else a_act.complete()}).execAC(function(){templateRender.templates[templateRender.markerHeader]&&(inlineTemplates[templateRender.markerHeader]=templateRender._header())}).execAC(function(){if(!fcf.empty(inlineTemplates)){for(var newResult="",curPos=0,endPos=0,lstPos=0;;){if(-1==(curPos=result.indexOf(templateRender.markerPrefix,lstPos))){newResult+=result.substr(lstPos);break}endPos=result.indexOf(templateRender.markerSuffix,curPos);var key=result.substr(curPos,endPos-curPos+templateRender.markerSuffix.length);newResult+=result.substr(lstPos,curPos-lstPos),newResult+=inlineTemplates[key],lstPos=endPos+templateRender.markerSuffix.length}result=newResult}a_options.onResult(void 0,result)})}({})},this._renderBlock=function(a_options,a_template){let ov=fcf.NDetails.currentTemplate;fcf.NDetails.currentTemplate=a_template,fcf.scriptExecutor.execute(a_options._innerfcf_currentTemplate,a_options,a_template,a_options.stringNumber),fcf.NDetails.currentTemplate=ov},this._getRenderingBlocks=function(a_templatePath,a_templateInfo,a_aliases){var octothorpePos=(a_templatePath=fcf.getPath(a_templatePath,a_aliases,!0)).indexOf("+");return-1!==octothorpePos?[a_templatePath.substr(octothorpePos+1,a_templatePath.length-octothorpePos-1)]:a_templateInfo.defaultBlocks}},NDetails.TemplateProcessor}}),fcf.module({name:"fcf:NRender/Template.js",dependencies:[],module:function(){var NRender=fcf.prepareObject(fcf,"NRender");return NRender.Template=function(a_options){this.content=fcf.empty(a_options.content)?"":a_options.content,this.id=a_options.id,this.args=a_options.args,this.state=a_options.state},NRender.Template}}),fcf.module({name:"fcf:NRender/NDetails/ArgsBuilder.js",dependencies:["fcf:NRender/NDetails/Loader.js","fcf:NRender/NDetails/TemplateProcessor.js","fcf:NRender/NDetails/ArgsDependecies.js","fcf:NRender/Template.js","fcf:NRender/NDetails/Helper.js","fcf:NRender/TaskInfo.js"],module:function(Loader,TemplateProcessor,ArgsDependecies,Template,helper,TaskInfo){var NDetails=fcf.prepareObject(fcf,"NRender.NDetails");return NDetails.ArgsBuilder=function(a_initializeOptions){var self=this;this._argsDependecies=new ArgsDependecies({}),this._templateProcessor=new TemplateProcessor({}),this.build=function(a_options){fcf.setContext(a_options.context);var fcfId=fcf.genId(),normalizeArgs={};for(var key in a_options.args)normalizeArgs[fcf.normalizeObjectAddress(key)]=a_options.args[key];var newInputArgs={};for(var key in a_options.inputArgs){newInputArgs[fcf.normalizeObjectAddress(key)]=a_options.inputArgs[key]}a_options.inputArgs=newInputArgs,fcf.setContext(a_options.context);var ti=new TaskInfo({owner:this,storage:fcf.application.getStorage(),route:a_options.route,request:a_options.request,context:a_options.context,_render:a_options.render,templatePath:a_options.templatePath,template:a_options.template,srcArgs:fcf.append(!0,{'["fcfWrapper"]':!0},normalizeArgs),fullSrcArgs:fcf.append(!0,{'["fcfWrapper"]':!0},normalizeArgs),args:{fcfId:fcfId},reqursion:a_options.reqursion,loader:a_options.loader,update:a_options.update,processedArgs:{},processedCounter:0,currentArgType:"system",lastArgType:void 0,_fcfTransformation:a_options.fcfTransformation,projections:a_options.projections?a_options.projections:fcf.application.getProjections().getProjections(),_start:!0,_firstProcessValue:!0,_firstProcessTemplate:!0,inputArgs:a_options.inputArgs,aliases:a_options.state.theme.getAliases(),state:a_options.state,currentTheme:void 0,systemArgsIsProcessed:!1,importants:{},_defaultFcfId:fcfId,_processFcfAlias:!1,_processPreFcfChildsArgs:!1,_processFcfChildsArgs:!1,_attach:{}});for(var k in normalizeArgs)fcf.isArg(normalizeArgs[k])&&normalizeArgs[k].important&&(ti.importants[k]=normalizeArgs[k]);for(var key in ti.state.args[fcfId]=ti.args,ti.state.sources[fcfId]=ti.fullSrcArgs,fcf.empty(a_options.fcfTransformation)||(ti.srcArgs['["fcfTransformation"]']=a_options.fcfTransformation,ti.fullSrcArgs['["fcfTransformation"]']=a_options.fcfTransformation),ti.actions=new fcf.Actions({onError:function(a_error){a_options.onResult(a_error,void 0)}}),a_options.inputArgs)ti.srcArgs[key]=a_options.inputArgs[key],ti.fullSrcArgs[key]=a_options.inputArgs[key];for(var key in ti.srcArgs){if(!(fcf.isArg(ti.srcArgs[key])&&"attach"in ti.srcArgs[key]))continue;let arg=fcf.normalizeObjectAddress(ti.srcArgs[key].attach.arg);arg in ti.srcArgs&&(fcf.isArg(ti.srcArgs[arg])||(ti.srcArgs[arg]=fcf.arg("value",{value:ti.srcArgs[arg]})),Array.isArray(ti.srcArgs[arg].dependencies)||(ti.srcArgs[arg].dependencies=[]),ti.srcArgs[arg].dependencies.push(key),ti._attach[arg]||(ti._attach[arg]=[]),ti._attach[arg].push(key))}try{helper.callHook(ti.template,"hookBeforeBuild",ti)}catch(e){return void ti.actions.error(e)}self._processedArgs(ti,function(){if(ti._defaultFcfId,ti.args.fcfId,fcf.isServer()){if(ti.request&&ti.args.fcfId){if(Array.isArray(ti.args.fcfInclude))for(var i=0;i<ti.args.fcfInclude.length;++i){let incl=ti.args.fcfInclude[i];ti.state.include[incl]=incl}if(ti.args.fcfWrapper&&(void 0===ti.args.fcfStorage||ti.args.fcfStorage)){ti.state.renderRestore[ti.args.fcfId]={},delete ti.fullSrcArgs['["fcfChildsArgs"]'],fcf.append(ti.state.renderRestore[ti.args.fcfId],ti.fullSrcArgs),fcf.each(a_options.inputArgs,function(a_key,a_value){'["fcfChildsArgs"]'!=a_key&&(ti.state.renderRestore[ti.args.fcfId][a_key]=a_value)});var data={};fcf.each(ti.fullSrcArgs,function(a_key,a_value){if('["fcfChildsArgs"]'!=a_key&&(!fcf.isArg(a_value)||"value"==a_value.type||"reference"==a_value.type||"programmable"==a_value.type)){var ptrData=fcf.resolveEx(data,a_key,!0);ptrData.object[ptrData.key]=fcf.resolve(ti.args,a_key)}}),ti.state.renderStorage[ti.args.fcfId]=data}}}else ti.args.fcfWrapper&&(void 0===ti.args.fcfStorage||ti.args.fcfStorage)&&(ti.update||fcf.getWrapper(ti.args.fcfId)||fcf.each(a_options.inputArgs,function(a_key,a_value){'["fcfChildsArgs"]'!=a_key&&fcf.application.getLocalData().setSourceItem(ti.args.fcfId,a_key,a_value)}),fcf.each(ti.fullSrcArgs,function(a_key,a_value){if((!fcf.isArg(a_value)||"value"==a_value.type||"reference"==a_value.type||"programmable"==a_value.type)&&'["fcfChildsArgs"]'!=a_key){var ptr=fcf.resolveEx(ti.args,a_key);ptr.object&&(fcf.application.getLocalData().setOriginItem(ti.args.fcfId,a_key,ptr.object[ptr.key]),ti.update&&fcf.application.getLocalData().setObject(ti.args.fcfId,{}))}}));if(ti.request&&ti.args.fcfId&&!fcf.empty(ti.args.fcfTheme)){if(!ti.reqursion){let newTheme=fcf.application.getThemes().getTheme(ti.args.fcfTheme);newTheme&&(ti.state.theme=newTheme)}ti.state.themes[ti.args.fcfTheme]=ti.args.fcfTheme}try{helper.callHook(ti.template,"hookAfterBuild",ti)}catch(e){return void a_act.error(e)}ti.actions.exec(function(a_act){a_options.onResult(void 0,ti.args,ti.fullSrcArgs),a_act.complete()})})},this._callHookBeforeArgument=function(a_taskInfo,a_argPath){a_taskInfo._processedHooksBeforeArgument||(a_taskInfo._processedHooksBeforeArgument={}),a_argPath in a_taskInfo._processedHooksBeforeArgument||(a_taskInfo._processedHooksBeforeArgument[a_argPath]=!0,helper.callHookBeforeArgument(a_taskInfo.template,a_argPath,a_taskInfo))},this._callProgrammableArgument=function(a_taskInfo,a_argPath){a_taskInfo._processedHooksProgrammableArguments||(a_taskInfo._processedHooksProgrammableArguments={}),a_argPath in a_taskInfo._processedHooksProgrammableArguments||(a_taskInfo._processedHooksProgrammableArguments[a_argPath]=!0,helper.callHookProgramableArgument(a_taskInfo.template,a_argPath,a_taskInfo))},this._callHookAfterArgument=function(a_taskInfo,a_argPath){a_taskInfo._processedHooksAfterArgument||(a_taskInfo._processedHooksAfterArgument={}),a_argPath in a_taskInfo._processedHooksAfterArgument||(a_taskInfo._processedHooksAfterArgument[a_argPath]=!0,helper.callHookAfterArgument(a_taskInfo.template,a_argPath,a_taskInfo))},this.getSystemArg=function(a_taskInfo){return this._getNextArg(a_taskInfo,"system")},this._getLevels=function(){return["system","reference","value","template","view","programmable","*"]},this.getArg=function(a_taskInfo){for(var types=this._getLevels(),typeIndex=fcf.find(types,a_taskInfo.currentArgType);;){var argPath=this._getNextArg(a_taskInfo,a_taskInfo.currentArgType);if(argPath)return a_taskInfo.lastArgType=a_taskInfo.currentArgType,argPath;if(a_taskInfo.lastArgType!=a_taskInfo.currentArgType){if(++typeIndex>=types.length)return;a_taskInfo.lastArgType=a_taskInfo.currentArgType,a_taskInfo.currentArgType=types[typeIndex]}else if(a_taskInfo.lastArgType==a_taskInfo.currentArgType&&"system"==a_taskInfo.currentArgType){if(++typeIndex>=types.length)return;a_taskInfo.lastArgType=a_taskInfo.currentArgType,a_taskInfo.currentArgType=types[typeIndex]}else a_taskInfo.lastArgType=a_taskInfo.currentArgType,a_taskInfo.currentArgType=types[0]}},this._processedArgs=function(a_taskInfo,a_cbComplete){function processArg(){++a_taskInfo.state.reqursionCounter<300?processArgUnsafe():(a_taskInfo.state.reqursionCounter=0,setTimeout(processArgUnsafe,0))}function processArgUnsafe(){var argPath=void 0;if(!a_taskInfo.systemArgsIsProcessed&&!(argPath=self.getSystemArg(a_taskInfo))){if(!a_taskInfo.currentTheme&&a_taskInfo.args.fcfTheme){a_taskInfo.currentTheme=a_taskInfo.args.fcfTheme;var theme=fcf.application.getThemes().getTheme(a_taskInfo.currentTheme);a_taskInfo.state.theme=theme,a_taskInfo.aliases=theme.getAliases()}a_taskInfo.systemArgsIsProcessed=!0,helper.callHook(a_taskInfo.template,"hookAfterSystemBuild",a_taskInfo)}if(a_taskInfo.systemArgsIsProcessed&&(argPath=self.getArg(a_taskInfo)),'["fcfChildsArgs"]'==argPath?a_taskInfo._processPreFcfChildsArgs=!0:a_taskInfo._processPreFcfChildsArgs&&!a_taskInfo._processFcfChildsArgs&&(a_taskInfo._processFcfChildsArgs=!0),argPath){try{self._callHookBeforeArgument(a_taskInfo,argPath)}catch(e){return void a_act.error(e)}var enableImportant=fcf.isArg(a_taskInfo.importants[argPath])&&a_taskInfo.importants[argPath].important&&(!fcf.isArg(a_taskInfo.srcArgs[argPath])||!a_taskInfo.srcArgs[argPath].important);processing(a_taskInfo,a_taskInfo.srcArgs,argPath,function(){enableImportant?processing(a_taskInfo,a_taskInfo.importants,argPath,function(){completeProcessing()}):completeProcessing()})}else a_taskInfo.actions.execAC(function(){a_cbComplete()});function processing(a_taskInfo,a_argContainer,a_argName,a_cb){a_taskInfo.actions.exec(function(a_act){fcf.isArg(a_argContainer[a_argName])&&(a_argContainer[a_argName]=self._tokenizeArg(a_argContainer[a_argName],a_taskInfo.args,a_taskInfo)),self._processedInnerArgs(argPath,a_argContainer[a_argName],a_taskInfo,function(a_error){a_error?a_taskInfo.actions.error(a_error):self._processedArg(argPath,a_argContainer[a_argName],a_taskInfo,function(a_error,a_data){if(a_error)a_taskInfo.actions.error(a_error);else{if(void 0!==a_data){var ptr=fcf.resolveEx(a_taskInfo.args,argPath,!0);ptr.object[ptr.key]=a_data}a_cb()}})}),a_act.complete()})}function completeProcessing(){if(delete a_taskInfo.srcArgs[argPath],a_taskInfo.processedArgs[argPath]=!0,'["fcfTransformation"]'==argPath)a_taskInfo._fcfTransformation=a_taskInfo.args.fcfTransformation,a_taskInfo.projections=fcf.application.getProjections().transformation(a_taskInfo.args.fcfTransformation).getProjections();else if('["fcfId"]'==argPath)a_taskInfo.state.args[a_taskInfo.args.fcfId]=a_taskInfo.args,a_taskInfo.state.sources[a_taskInfo.args.fcfId]=a_taskInfo.fullSrcArgs;else if('["fcfDependencies"]'==argPath&&"object"==typeof a_taskInfo.args.fcfDependencies)for(var key in a_taskInfo.args.fcfDependencies){var normKey=fcf.normalizeObjectAddress(key),deps=a_taskInfo.args.fcfDependencies[key];normKey in a_taskInfo.srcArgs&&(fcf.isArg(a_taskInfo.srcArgs[normKey])||(a_taskInfo.srcArgs[normKey]=fcf.arg("value",{value:a_taskInfo.srcArgs[normKey]})),a_taskInfo.srcArgs[normKey].dependencies||(a_taskInfo.srcArgs[normKey].dependencies=[]),deps=Array.isArray(deps)?deps:[deps],fcf.append(a_taskInfo.srcArgs[normKey].dependencies,deps))}if(argPath in a_taskInfo._attach)for(var i=0;i<a_taskInfo._attach[argPath].length;++i){let srcPath=a_taskInfo._attach[argPath][i],srcParams=a_taskInfo.fullSrcArgs[srcPath].attach,srcData=fcf.resolve(a_taskInfo.args,srcPath),dstDataPtr=fcf.resolveEx(a_taskInfo.args,argPath);dstDataPtr.object[dstDataPtr.key]=fcf.merge(dstDataPtr.object[dstDataPtr.key],srcData,srcParams)}try{self._callHookAfterArgument(a_taskInfo,argPath)}catch(e){return void a_taskInfo.actions.error(e)}a_taskInfo.actions.execAC(function(){processArg()})}}processArg()},this._processedInnerArgs=function(a_argPath,a_srcArg,a_taskInfo,a_cb){if('["fcfChildsArgs"]'!=a_argPath){var a_arrPaths,innerSrcArgs=(a_arrPaths=function clFindInnerArg(a_value,a_path,a_result){return a_result||(a_result=[]),fcf.each(a_value,function(a_key,a_v){var path=fcf.append([],a_path);path.push(a_key),fcf.isArg(a_v)?(a_value[a_key]=self._tokenizeArg(a_v,a_taskInfo.args,a_taskInfo),fcf.isArg(a_srcArg)&&("template"==a_srcArg.type||"view"==a_srcArg.type)&&"reference"==a_v.type||a_result.push(path)):"object"==typeof a_v&&clFindInnerArg(a_v,path,a_result)}),a_result}(a_srcArg),fcf.each(a_arrPaths,function(a_key,a_value){for(var line="",i=0;i<a_value.length;++i)line+='["'+fcf.escapeQuotes(a_value[i])+'"]';a_arrPaths[a_key]=line}),a_arrPaths);new fcf.Actions({onError:function(a_error){a_cb(a_error)}}).each(innerSrcArgs,function(a_act,a_key,a_value){var ptr=fcf.resolveEx(a_srcArg,a_value),innerSrcArg=ptr.object[ptr.key];self._processedArg(a_argPath+"->"+a_key,innerSrcArg,a_taskInfo,function(a_error,a_data){if(a_error)a_act.error(a_error);else{var ptr=fcf.resolveEx(a_srcArg,a_value);ptr.object[ptr.key]=a_data,a_act.complete()}})}).execAC(function(){a_cb()})}else a_cb()},this._processedArg=function(a_argPath,a_srcArg,a_taskInfo,a_cb){void 0!==a_srcArg?(fcf.setContext(a_taskInfo.context),fcf.isArg(a_srcArg)&&"value"!=a_srcArg.type?"reference"==a_srcArg.type?self._processReference(a_srcArg,a_taskInfo,a_cb):"template"==a_srcArg.type?self._processTemplate(a_argPath,a_srcArg,a_taskInfo,a_cb):"view"==a_srcArg.type?self._processView(a_argPath,a_srcArg,a_taskInfo,a_cb):"programmable"==a_srcArg.type&&a_argPath?(self._callProgrammableArgument(a_taskInfo,a_argPath),a_taskInfo.actions.execAC(function(){a_cb(void 0)})):a_cb(void 0):a_cb(void 0,self._processValue(a_srcArg,a_taskInfo))):a_cb(void 0)},this._processReference=function(a_srcArg,a_taskInfo,a_cb){var data=void 0;if(fcf.isServer())data=fcf.resolve(a_taskInfo.state.args[a_srcArg.id],a_srcArg.arg);else{var wrp=fcf.getWrapper(a_srcArg.id);wrp?data=wrp.getArg(a_srcArg.arg):void 0===data&&(data=fcf.resolve(a_taskInfo.state.args[a_srcArg.id],a_srcArg.arg))}a_cb(void 0,data)},this._processTemplate=function(a_argPath,a_srcArg,a_taskInfo,a_cb){this._processTemplateItem(0,a_argPath,a_srcArg.template,a_srcArg.args,a_taskInfo,function(a_error,a_content){a_error?a_cb(a_error):a_cb(void 0,a_content)})},this._processTemplateItem=function(a_callIndex,a_argPath,a_template,a_inputArgs,a_taskInfo,a_cb){var rootTemplateFile=a_taskInfo.templatePath.split("+")[0];if(0==a_template.indexOf("+"))var templatePath=rootTemplateFile+"+"+a_template.substr(1);else templatePath=a_template;var templateFile=templatePath.split("+")[0];fcf.getPath(rootTemplateFile),fcf.getPath(templateFile);inputArgs=fcf.append(!0,{},a_inputArgs),a_taskInfo.args.fcfWrapper&&(inputArgs.fcfParent=a_taskInfo.args.fcfId),helper.appendChildInfo(inputArgs,a_taskInfo.args,a_taskInfo.args.fcfChildsArgs),inputArgs.fcfCP="tmpl:"+a_argPath+":"+a_callIndex,a_taskInfo._render.render({template:templatePath,theme:a_taskInfo.state.theme.getName(),route:a_taskInfo.route,context:a_taskInfo.context,state:a_taskInfo.state,request:a_taskInfo.request,update:a_taskInfo.update,reqursion:!0,projections:a_taskInfo.projections,fcfTransformation:a_taskInfo._fcfTransformation,args:fcf.unescapeObject(inputArgs),onResult:function(a_error,a_template){a_error?a_cb(a_error):a_cb(void 0,a_template.content)}})},this._processView=function(a_argPath,a_srcArg,a_taskInfo,a_cb){var view=a_srcArg.view,mode=a_srcArg.fcfMode?a_srcArg.fcfMode:a_taskInfo.args.fcfMode?a_taskInfo.args.fcfMode:"read",template=a_taskInfo.state.theme.getView(mode,a_srcArg.view).template,templateArgs=(view=fcf.buildModeObject(mode,a_srcArg.view,"usage"),fcf.append(!0,{},view));fcf.append(templateArgs,a_srcArg.view.templateArgs),templateArgs.record=a_srcArg.record,templateArgs.fcfParent=a_taskInfo.args.fcfWrapper?a_taskInfo.args.fcfId:void 0,a_taskInfo.args.fcfMode&&(templateArgs.fcfMode=a_taskInfo.args.fcfMode),templateArgs.fcfKey=a_taskInfo.args.fcfKey,templateArgs.view=a_srcArg.view,templateArgs.fcfClass=a_taskInfo.args.fcfChildClass,templateArgs.fcfCP="view:"+a_argPath,templateArgs.value=fcf.isArg(a_srcArg.value)?fcf.unescapeObject(a_srcArg.value):fcf.empty(a_srcArg.value)?fcf.isArg(view.value)?fcf.unescapeObject(view.value):fcf.empty(view.value)?fcf.isArg(view.default)?fcf.unescapeObject(view.default):fcf.empty(view.default)?void 0:fcf.arg("value",{value:fcf.unescapeObject(view.default)}):fcf.arg("value",{value:fcf.unescapeObject(view.value)}):fcf.arg("value",{value:fcf.unescapeObject(a_srcArg.value)}),helper.appendChildInfo(templateArgs,templateArgs,a_taskInfo.args.fcfChildsArgs),a_taskInfo._render.render({template:template,state:a_taskInfo.state,theme:a_taskInfo.state.theme.getName(),route:a_taskInfo.route,projections:a_taskInfo.projections,fcfTransformation:a_taskInfo._fcfTransformation,request:a_taskInfo.request,args:templateArgs,context:a_taskInfo.context,update:a_taskInfo.update,reqursion:!0,onResult:function(a_error,a_template){a_error?a_cb(a_error):a_cb(void 0,a_srcArg.fullResult?a_template:a_template.content)}})},this._normalizeSrcArgs=function(a_srcArgs){var result={};for(var key in a_srcArgs)result[fcf.normalizeObjectAddress(key)]=a_srcArgs[key];return result},this.isPreparedValue=function(a_value){if("string"==typeof a_value){var reg=new RegExp("([^\\\\][@#$]{{)|(^[@#$]{{)"),m=a_value.match(reg);return fcf.empty(m)}if("object"==typeof a_value){var res=!0;return fcf.foreach(a_value,function(k,v){res&=this.isPreparedValue(v)}),res}return!0},this._processValue=function(a_srcArg,a_taskInfo){var isex=fcf.isArg(a_srcArg),value=isex?a_srcArg.value:a_srcArg,needDefault=!1;if("string"==typeof value&&(needDefault=-1!=value.indexOf("${{")||-1!=value.indexOf("#{{")||-1!=value.indexOf("@{{")),(fcf.empty(value)||needDefault)&&isex&&"default"in a_srcArg&&(value=a_srcArg.default,needDefault=!1),(fcf.empty(value)||needDefault)&&isex&&Array.isArray(a_srcArg.defaults))for(var defaults=a_srcArg.defaults,i=0;i<defaults.length;++i)if(!fcf.empty(defaults[i])&&this.isPreparedValue(defaults[i])){value=defaults[i];break}if(isex&&"object"==typeof a_srcArg.merge){var merge=fcf.isEnumerable(a_srcArg.merge)?a_srcArg.merge:[a_srcArg.merge];for(i=0;i<merge.length;++i)value=fcf.merge(value,merge[i].value,merge[i].options)}return value},this._tokenizeArg=function(a_srcArg,a_args,a_taskInfo){var args={args:a_args,source:a_srcArg,route:a_taskInfo.route,projections:fcf.application.getProjections().getProjections()};return fcf.tokenizeObject(a_srcArg,args,!0)},this._getNextArg=function(a_taskInfo,a_type){for(var key in a_taskInfo.srcArgs){if("system"==a_type){if(0!==key.indexOf('["fcf'))continue}else{var src=fcf.isArg(a_taskInfo.srcArgs[key])?a_taskInfo.srcArgs[key]:fcf.arg("value");if(!(a_type==(src.level?src.level:src.type))&&"*"!=a_type)continue}fcf.isArg(a_taskInfo.importants[key])?a_taskInfo.importants[key]:fcf.arg("value");var deps=[];fcf.isArg(a_taskInfo.srcArgs[key])&&(deps=this._getTokenizeDependencies(a_taskInfo,a_taskInfo.srcArgs[key]),fcf.append(deps,a_taskInfo.srcArgs[key].dependencies)),fcf.isArg(a_taskInfo.importants[key])&&(fcf.append(deps,this._getTokenizeDependencies(a_taskInfo,a_taskInfo.importants[key])),fcf.append(deps,a_taskInfo.importants[key].dependencies));for(var inwaiting=!1,i=0;i<deps.length&&!(inwaiting|=this._checkWaiting(deps[i],a_taskInfo));++i);if(!inwaiting&&("*"==a_type||key!=['["fcfChildsArgs"]']||!a_taskInfo.fullSrcArgs['["fcfCP"]']||!(inwaiting|=this._checkWaiting("args."+["fcfCP"],a_taskInfo))))return key}if("*"==a_type)for(var key in a_taskInfo.srcArgs)return key},this._checkWaiting=function(a_path,a_taskInfo){if((a_path=fcf.normalizeObjectAddress(a_path))in a_taskInfo.processedArgs)return!1;var ptr=fcf.resolveEx(a_taskInfo.srcArgs,a_path);return!(ptr.object&&ptr.key in ptr.object)},this._getTokenizeDependencies=function(a_taskInfo,a_srcArgs,_a_dst){var isRoot=!1;for(var k in void 0===_a_dst&&(_a_dst={},isRoot=!0),a_srcArgs)if("string"==typeof a_srcArgs[k])if(0==a_srcArgs[k].indexOf("#{{")&&a_srcArgs[k].indexOf("}}#")==a_srcArgs[k].length-3){var addr=fcf.trim(a_srcArgs[k].substr(3,a_srcArgs[k].length-6));"router"!=fcf.parseObjectAddress(addr)[0]&&(_a_dst[addr]=!0)}else for(var keys=fcf.getVariablesString(a_srcArgs[k]),i=0;i<keys.length;++i){"router"!=fcf.parseObjectAddress(keys[i])[0]&&(_a_dst[keys[i]]=!0)}else"object"==typeof a_srcArgs[k]&&this._getTokenizeDependencies(a_taskInfo,a_srcArgs[k],_a_dst);if(fcf.isArg(a_srcArgs)&&"reference"==a_srcArgs.type&&(a_srcArgs.id==a_taskInfo.args.fcfId||"${{args.fcfId}}$"==a_srcArgs.id||"@{{args.fcfId}}@"==a_srcArgs.id)){var arg=fcf.parseObjectAddress(a_srcArgs.arg)[0];void 0!==arg&&(_a_dst[arg]=!0)}if(isRoot){var result=[];for(var k in _a_dst)result.push(k);return result}}},NDetails.ArgsBuilder}}),fcf.module({name:"fcf:NRender/Render.js",dependencies:["fcf:NRender/NDetails/Loader.js","fcf:NRender/NDetails/TemplateProcessor.js","fcf:NRender/NDetails/ArgsDependecies.js","fcf:NRender/NDetails/ArgsBuilder.js","fcf:NRender/Template.js"],module:function(Loader,TemplateProcessor,ArgsDependecies,ArgsBuilder,Template){var NRender=fcf.prepareObject(fcf,"NRender");return NRender.Render=function(a_initializeOptions){var self=this;this._options=fcf.append({},a_initializeOptions),this._options.template=this._options.template,this._loader=new Loader,this._argsDependecies=new ArgsDependecies({}),this._defaultRouteInfo=a_initializeOptions.routeInfo?a_initializeOptions.routeInfo:{args:{}},this.setFileСaching=function(a_value){this._options.fileСaching=a_value,this._loader.setSettings({"fileСaching":a_value})},this.render=function(a_options){a_options.context&&fcf.setContext(a_options.context),argsBuilder=new ArgsBuilder({}),templateProcessor=new TemplateProcessor({render:this,loader:this._loader});var needOnServer=!fcf.isServer()&&fcf.getContext().get("needBabel"),breakExecution=needOnServer,part=a_options.template.split("+")[1]?a_options.template.split("+")[1]:"",resultContext="",fullTemplate=void 0,rawTemplate=void 0,resultArgs={},resultSources={},defaultThemeName=a_options.theme?a_options.theme:"defaultTheme",defaultTheme=fcf.application.getThemes().getTheme(defaultThemeName,!0),externalArgs="object"==typeof a_options.externalArgs?a_options.externalArgs:{},isExternalEmpty=!0;for(let k in externalArgs)externalArgs[k].__innerFcfPostRemove=!0,isExternalEmpty=!1;var isRootCall=!a_options.state,state=a_options.state?a_options.state:{theme:defaultTheme,defaultTheme:defaultTheme,themes:{},include:{},renderRestore:{},renderStorage:{},reqursionCounter:0,args:externalArgs,sources:{}},action=new fcf.Actions;return action.append(function(a_act){needOnServer?a_act.complete():(state.theme,self._loader.load(a_options.template,state,function(a_error,a_fullTemplate){a_error?a_act.error(a_error):(rawTemplate=(fullTemplate=a_fullTemplate).templates[part])?a_act.complete():a_act.error(new fcf.Exception("ERROR_RENDER_TEMPLATE_NOT_FOUND",{template:a_options.template}))}))}),action.append(function(a_act){needOnServer||fullTemplate.options.serverOnly&&!fcf.isServer()?(breakExecution=!0,fcf.loadObject({path:"@url:fcfRender",post:{template:a_options.template,args:a_options.args,update:a_options.update,url:window.location.href,externalArgs:a_options.externalArgs},onResult:function(a_error,a_response){if(a_error)a_act.error(a_error);else{var resultTemplate=new Template({content:a_response.content,id:a_response.id,args:a_response.args,state:a_response.state});fcf.append(state.args,a_response.state.args),fcf.append(state.sources,a_response.state.sources),resultTemplate.args.fcfError?a_act.error(resultTemplate.args.fcfError):(a_options.onResult&&a_options.onResult(void 0,resultTemplate),a_act.complete(resultTemplate))}}})):a_act.complete()}),action.append(function(a_act,a_result){if(breakExecution)a_act.complete(a_result);else{var args="object"==typeof a_options.args?a_options.args:{};argsBuilder.build({render:self,request:a_options.request,context:a_options.context?a_options.context:fcf.getContext(),state:state,reqursion:a_options.reqursion,templatePath:a_options.template,route:a_options.route?a_options.route:self._defaultRouteInfo,loader:self._loader,projections:a_options.projections,args:rawTemplate.arguments,template:rawTemplate,update:a_options.update,inputArgs:args,onResult:function(a_error,a_args,a_sources){a_error?a_act.error(a_error):(resultArgs=a_args,resultSources=a_sources,a_act.complete())}})}}),action.append(function(a_act,a_result){if(breakExecution)a_act.complete(a_result);else{var params={render:self,request:a_options.request,context:a_options.context?a_options.context:fcf.getContext(),template:a_options.template,rawTemplate:rawTemplate,route:a_options.route?a_options.route:self._defaultRouteInfo,request:a_options.request,args:resultArgs,sources:resultSources,projections:a_options.projections,state:state,loader:self._loader,onResult:function(a_error,a_content){a_error?a_act.error(a_error):(resultContext=a_content,a_act.complete())}};templateProcessor.build(params)}}),action.append(function(a_act,a_result){if(breakExecution)a_act.complete(a_result);else{if(!isExternalEmpty&&isRootCall){let rm=[];for(let k in state.args)state.args[k].__innerFcfPostRemove&&rm.push(k);for(let i=0;i<rm.length;++i)delete state.args[rm[i]]}var args=resultArgs;delete args.fcfChildsArgs;var resultTemplate=new Template({content:resultContext,id:resultArgs.fcfId,args:args,state:{args:state.args,sources:state.sources}});resultTemplate.args.fcfError?a_act.error(resultTemplate.args.fcfError):(a_options.onResult&&a_options.onResult(void 0,resultTemplate),a_act.complete(resultTemplate))}}),action.catch(function(a_error){a_options.onResult&&a_options.onResult(a_error,new Template({}))}),action.startup(),action},this.getLoader=function(){return this._loader},this.getStorage=function(){return this._options.storage},this._normalizeArgsKeys=function(a_args){var res={};for(var k in a_args)res[fcf.normalizeObjectAddress(k)]=a_args[k];return res}},NRender.Render}}),fcf.isServer())var fs=require("fs"),modulePath=require("path");fcf.module({name:"fcf:NFSQL/Projections.js",dependencies:[],module:function(){return fcf.prepareObject(fcf,"NFSQL"),fcf.addException("ERROR_PROJECTION_UNKNOWN_JOIN_FIELD","Incorrect '${{projection}}$' projection is specified in the join property for the ${{field}}$ field"),fcf.NFSQL.Projections=function(){var self=this;this._descs={},this._reloadDirs={},this._pendingExtends={},this._pendingJoin={},this.load=function(a_projectionName,a_cb){if(a_projectionName in this._descs)a_cb(void 0,this._descs[a_projectionName]);else{var path=fcf.settings.routeAliases.fsql+(-1==fcf.settings.routeAliases.fsql.indexOf("?")?"?":"&")+"projection="+(fcf.empty(a_projectionName)?"":a_projectionName);fcf.load({path:path,onResult:function(a_error,a_data){if(a_error)a_cb(a_error,void 0);else try{var data=fcf.scriptExecutor.parse(a_data,{},path,0);if(data.error)return void a_cb(data.error,void 0);for(var i=0;i<data.projections.length;++i)self.appendProjectionStruct(data.projections[i]);a_cb(void 0,self.get(a_projectionName))}catch(error){a_cb(error,void 0)}}})}},this.transformation=function(a_transformation){var projections=this.clone(),projectionsMap=projections.getProjections();for(var alias in projectionsMap){var isFirstTransformation=!0;for(var transformationName in a_transformation)if(projectionsMap[alias].transformation&&projectionsMap[alias].transformation[transformationName]){isFirstTransformation&&(projectionsMap[alias]=fcf.append(!0,{},projectionsMap[alias])),isFirstTransformation=!1;var transformationItems=fcf.tokenizeObject(projectionsMap[alias].transformation[transformationName],a_transformation[transformationName]);if(Array.isArray(transformationItems))for(var i=0;i<transformationItems.length;++i){var item=transformationItems[i];if(item.source){var ptr=fcf.resolveEx(projectionsMap[alias],item.source,!0);ptr.object[ptr.key]=item.value}}}}return projections},this.loadFromDirectory=function(a_path,a_recursion){a_recursion||(this._reloadDirs[a_path]=!0);var files=fs.readdirSync(a_path);for(var key in files){var fpath=a_path+"/"+files[key];try{var isDir;try{isDir=fs.statSync(fpath).isDirectory()}catch(e){continue}if(isDir)this.loadFromDirectory(fpath,a_recursion);else{if(fpath.length<12)continue;if(".projection"!=fpath.substr(-11))continue;this.loadFromFiles(fpath)}}catch(e){throw fcf.log.err("","Can't load projection file '"+fpath+"': ("+e.toString()+")"),e}}},this.loadFromFiles=function(a_paths){let self=this;"string"==typeof a_paths&&(a_paths=[a_paths]);let projections={};fcf.each(a_paths,(a_key,a_path)=>{a_path=modulePath.resolve(fcf.getPath(a_path));let raw=fs.readFileSync(a_path,"utf8"),obj=eval("("+raw+")"),proj=self.appendProjectionStruct(obj);projections[proj.alias]=proj})},this._reloadDirectories=function(){try{for(var dirPath in this._reloadDirs)this.loadFromDirectory(dirPath)}catch(e){fcf.log.err("FCF",e)}fcf.application.getSettings().projectionReloadingTimeout&&setTimeout(function(){self._reloadDirectories()},fcf.application.getSettings().projectionReloadingTimeout)},this.clone=function(){var projections=new fcf.NFSQL.Projections;return fcf.append(projections._descs,this._descs),projections},this.appendProjections=function(a_projections){fcf.append(this._descs,a_projections._descs)},this.appendProjectionStruct=function(a_objProjection){if((a_objProjection=fcf.append({},a_objProjection)).fields=fcf.append([],a_objProjection.fields),a_objProjection.extends&&!(a_objProjection=this._extends(a_objProjection)))return;a_objProjection.externalAccess=fcf.append({read:!0,edit:!0,add:!0,delete:!0},a_objProjection.externalAccess),a_objProjection.singleTitle=a_objProjection.singleTitle?a_objProjection.singleTitle:"";let translate=!1;for(var i=0;i<a_objProjection.fields.length;++i){var f=a_objProjection.fields[i];"field"in f||(f.field=f.alias),"alias"in f||(f.alias=f.field),"title"in f||(f.title=f.alias),f.translate&&(translate=!0)}return translate&&(a_objProjection.translate=!0),"connectionGroup"in a_objProjection||(a_objProjection.connectionGroup="default"),this._descs[a_objProjection.alias]=this._createAdaptProjection(a_objProjection),this._processJoinFileds(a_objProjection.alias),this._continueProcessingPendingExtends(),this._processJoinFileds(),this._descs[a_objProjection.alias]},this.get=function(a_alias){return this._descs[a_alias]},this.getProjections=function(){return this._descs},this.checkProjections=function(){fcf.each(this._descs,(a_key,a_projection)=>{if(fcf.empty(a_projection.alias))throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:"alias",projection:a_projection.alias});if(fcf.empty(a_projection.table))throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:"table",projection:a_projection.alias});if(fcf.empty(a_projection.title))throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:"title",projection:a_projection.alias});if(fcf.empty(a_projection.key))throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:"key",projection:a_projection.alias});if(fcf.empty(a_projection.join)||fcf.each(a_projection.join,(a_key,a_join)=>{if(a_join.as&&!fcf.getProjection(a_join.from))throw new fcf.Exception("ERROR_UNKNOWN_PROJECTION_IN_JOIN",{joinProjection:a_join.from,projection:a_projection.alias});if(fcf.empty(a_join.where))throw new fcf.Exception("ERROR_PROJECTION_UNSET_WHERE",{projection:a_projection.alias})}),fcf.empty(a_projection.fields))throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:"fields",projection:a_projection.alias});fcf.each(a_projection.join,(a_key,a_field)=>{if(fcf.empty(a_field.alias))throw new fcf.Exception("ERROR_PROJECTION_UNSET_ALIAS",{projection:a_projection.alias});if(fcf.empty(a_field.type))throw new fcf.Exception("ERROR_PROJECTION_UNSET_TYPE",{projection:a_projection.alias});let filter=fcf.getFilter(a_field);if(filter)throw new fcf.Exception("ERROR_UNKNOWN_FIELD_TYPE",{param:a_field.alias,projection:a_projection.alias});filter.checkStructure(a_projection,a_field)})})},this._processJoinFileds=function(a_projection){var projections=a_projection?[a_projection]:this._pendingJoin;fcf.each(projections,function(keyProjection,projectionAlias){var projection=self.get(projectionAlias),fullProcess=!0;fcf.each(projection.fields,function(keyField,field){if("object"==typeof field.join){var joinKey=fcf.find(projection.join,function(a_key,a_value){return a_value.as==field.join.from||a_value.from==field.join.from});if(void 0===joinKey)throw new fcf.Exception("ERROR_PROJECTION_UNKNOWN_JOIN_FIELD",{projection:projection.alias,field:field.alias});var join=projection.join[joinKey];if(!self.get(join.from))return self._pendingJoin[projection.alias]=projection.alias,void(fullProcess=!1);var jfield=self.get(join.from).mapFields[field.join.field],newField=fcf.append({},jfield,field);fcf.append(field,newField)}}),fullProcess&&delete self._pendingJoin[projection.alias]})},this._continueProcessingPendingExtends=function(){var numberProcessed=void 0;do{numberProcessed=0;var rmkeys=[];for(var k in this._pendingExtends){var projection=this._extends(this._pendingExtends);projection&&(rmkeys.push(k),this._descs[projection.alias]=this._createAdaptProjection(projection),this._processJoinFileds(projection.alias),this._processJoinFileds(),++numberProcessed)}for(var i=0;i<rmkeys.length;++i)delete this._pendingExtends[rmkeys[i]]}while(0!=numberProcessed)},this._extends=function(a_objProjection){var parent=this.get(a_objProjection.extends);if(parent){var expandableProjection=fcf.append(!0,{},parent);delete expandableProjection.mapFields,fcf.append(expandableProjection,a_objProjection),expandableProjection.fields=fcf.append(!0,[],parent.fields);for(var expandableFields=expandableProjection.fields,selfFields=a_objProjection.fields,i=0;i<selfFields.length;++i){var key=fcf.find(expandableFields,function(k,v){return v.alias==selfFields[i].alias});void 0===key?expandableFields.push(selfFields[i]):selfFields[i].extends?fcf.append(expandableFields[key],selfFields[i]):expandableFields[key]=selfFields[i]}return expandableProjection}this._pendingExtends[a_objProjection.alias]=a_objProjection},this._createAdaptProjection=function(a_objProjection){var adaptProjection=fcf.append({},a_objProjection);for(var key in adaptProjection.mapFields={},adaptProjection.fields)adaptProjection.mapFields[adaptProjection.fields[key].alias]=adaptProjection.fields[key];return adaptProjection},fcf.application&&fcf.application.getSettings()&&!fcf.application.getSettings().fileСaching&&setTimeout(function(){self._reloadDirectories()},2e3)},fcf.NFSQL.Projections}}),fcf.module({name:"fcf:NFSQL/NDetails/Errors.js",dependencies:[],module:function(){fcf.addException("ERROR_NFSQL_EXTERNAL_ACCESS_DENIED","External access is denied for projection '${{projection}}$'. Mode: ${{mode}}$"),fcf.addException("ERROR_NFSQL_UNKNOWN_FUNCTION","The request uses an unknown function '${{function}}$'"),fcf.addException("ERROR_NFSQL_UNKNOWN_PROJECTION_IN_QUERY","The projection ${{1}}$ specified was not found in the request"),fcf.addException("ERROR_NFSQL_UNKNOWN_CLIENT_GROUP_IN_QUERY","DB connection client not found for connection group ${{1}}$"),fcf.addException("ERROR_NFSQL_UNKNOWN_PROJECTION_IN_REF","The projection ${{refproj}}$ of the reference field ${{field}}$ is not available"),fcf.addException("ERROR_NFSQL_UNKNOWN_FIELD_IN_REF","The ${{reffield}}$ field does not exist for the reference field ${{field}}$"),fcf.addException("ERROR_NFSQL_MISSING_FIELD_HANDLER","The '${{projection}}$.${{field}}$ ' field does not have a handler for '${{handlerName}}$'"),fcf.addException("ERROR_NFSQL_UNKNOWN_PROJECTION_IN_FIELD","The projection ${{projection}}$ for the field ${{field}}$ is not available"),fcf.addException("ERROR_NFSQL_UNKNOWN_FIELD_IN_QUERY","The field ${{field}}$ is missing in the projection ${{projection}}$"),fcf.addException("ERROR_NFSQL_UNKNOWN_FUNCTION_IN_QUERY","The ${{function}}$ function specified in the request is not available"),fcf.addException("ERROR_NFSQL_FIELD_SINGLE_REF_INCORECT_SUBFIELD","An invalid subfield ${{subfield}}$ was specified for the field '${{projection}}$.${{field}}$'"),fcf.addException("ERROR_NFSQL_FIELD_SINGLE_REF_INCORECT_MODE","Invalid mode specified in the ${{mode}}$ for the '${{projection}}$.${{field}}$' field"),fcf.addException("ERROR_NFSQL_FIELD_MAX_LENGTH","The length of the field '${{projection}}$.${{field}}$' exceeds the maximum length of ${{length}}$"),fcf.addException("ERROR_NFSQL_FIELD_MIN_LENGTH","The length of the field '${{projection}}$.${{field}}$' is less than the minimum length ${{length}}$"),fcf.addException("ERROR_NFSQL_NOTNULL_FIELD_NOTNULL","The field '${{projection}}$.${{field}}$' marked as NOT NULL is not specified"),fcf.addException("ERROR_NFSQL_NOTNULL_FIELD_NOTCREATE","The field ' ${{projection}}$.${{field}}$' cannot be set when creating a record"),fcf.addException("ERROR_NFSQL_INCORRECT_INTEGER_TYPE","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' does not match the int type"),fcf.addException("ERROR_NFSQL_INCORRECT_INTEGER_MIN","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' is less than the minimum value ${{min}}$"),fcf.addException("ERROR_NFSQL_INCORRECT_INTEGER_MAX","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' is greater than the maximum value ${{max}}$"),fcf.addException("ERROR_NFSQL_INCORRECT_FLOAT_TYPE","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' does not match the float type"),fcf.addException("ERROR_NFSQL_INCORRECT_FLOAT_MIN","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' is less than the minimum value ${{min}}$"),fcf.addException("ERROR_NFSQL_INCORRECT_FLOAT_MAX","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' is greater than the maximum value ${{max}}$"),fcf.addException("ERROR_NFSQL_INCORRECT_BOOLEAN_TYPE","The value ${{value}}$ of the field '${{projection}}$.${{field}}$' does not match the boolean type"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_PROJECTION","The '${{refprojection}}$' projection of an external link is not available for the '${{projection}}$.${{field}}$' field"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_SELFFIELD","The selfField parameter for the field '${{projection}}$.${{field}}$ ' refers to the invalid field '${{refprojection}}$.${{reffield}}$'"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_REFFIELD","The refField parameter for the field '${{projection}}$.${{field}}$ ' refers to the invalid field '${{refprojection}}$.${{reffield}}$'"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_SELFFIELD_NOTREF","The selfField parameter for the field '${{projection}}$.${{field}}$' refers to the field '${{refprojection}}$.${{reffield}}$' which is not a singleref type"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_REFFIELD_NOTREF","The refField parameter for the field '${{projection}}$.${{field}}$' refers to the field '${{refprojection}}$.${{reffield}}$' which is not a single red type"),fcf.addException("ERROR_NFSQL_FIELD_EXTERNREF_INCORRECT_SUBFIELD","The field '${{projection}}$.${{field}}$' does not support the subfield '${{subfield}}$'"),fcf.addException("ERROR_NFSQL_INCORRECT_QUERY_OBJECT","Invalid object request format"),fcf.addException("ERROR_NFSQL_INCORRECT_TYPE_QUERY","Invalid object request type ${{type}}$")}}),fcf.module({name:"fcf:NFSQL/NDetails/SingleBuilder.js",dependencies:["fcf:NFSQL/NDetails/Errors.js"],module:function(NFSQLErrors){var NDetails=fcf.prepareObject(fcf,"NFSQL.NDetails");return NDetails.SingleBuilder=function(){this.build=function(a_query,a_startArgCounter){if("object"!=typeof a_query)throw new fcf.Exception("ERROR_NFSQL_INCORRECT_QUERY_OBJECT",[]);if(a_startArgCounter=a_startArgCounter||0,"delete"===a_query.type)return this._buildDelete(a_query,a_startArgCounter);if("update"===a_query.type)return this._buildUpdate(a_query,a_startArgCounter);if("insert"===a_query.type)return this._buildInsert(a_query,a_startArgCounter);if("select"===a_query.type)return this._buildSelect(a_query,a_startArgCounter);throw new fcf.Exception("ERROR_NFSQL_INCORRECT_TYPE_QUERY",{type:a_query.type})},this._buildSelect=function(a_query,a_startArgCounter){for(var result={query:"SELECT",args:[],details:{count:a_startArgCounter}},isFirst=!0,i=0;i<a_query.fields.length;++i)result.query+=isFirst?" ":", ",this._buildArgResult(result,a_query.fields[i]),isFirst=!1;if(result.query+=" FROM ",this._buildFrom(result,a_query.from),Array.isArray(a_query.join))for(i=0;i<a_query.join.length;++i){var join=a_query.join[i];if(result.query+="string"==typeof join.join&&"left"==join.join.toLowerCase()?" LEFT JOIN ":"string"==typeof join.join&&"right"==join.join.toLowerCase()?" RIGHT JOIN ":" JOIN ","object"==typeof join.query){var subquery=this.build(join.query,result.details.count);result.query+="(",result.query+=subquery.query,result.query+=")",fcf.append(result.args,subquery.args),result.details.count+=subquery.args.length}else this._buildSafeElement(result,join.from);fcf.empty(join.as)||(result.query+=" AS ",this._buildSafeElement(result,join.as)),result.query+=" ON",this._buildWhere(result,join.on,!0)}if(this._buildWhere(result,a_query.where),!fcf.empty(a_query.group)){result.query+=" GROUP BY ";for(isFirst=!0,i=0;i<a_query.group.length;++i)result.query+=isFirst?"":", ",isFirst=!1,this._buildSafeElement(result,a_query.group[i])}if(!fcf.empty(a_query.order)){result.query+=" ORDER BY";for(isFirst=!0,i=0;i<a_query.order.length;++i)result.query+=isFirst?" ":", ",isFirst=!1,this._buildField(result,a_query.order[i]),result.query+="desc"==a_query.order[i].order.toLowerCase()?" DESC":" ASC"}return fcf.empty(a_query.limit)||(result.query+=" LIMIT ",this._buildValue(result,a_query.limit)),fcf.empty(a_query.offset)||(result.query+=" OFFSET ",this._buildValue(result,a_query.offset)),fcf.empty(a_query.language)||(result.query+=" LANGUAGE "+a_query.language,a_query.defaultLanguage&&(result.query+=" DEFAULT ")),delete result.details,result},this._buildInsert=function(a_query,a_startArgCounter){var result={query:"INSERT INTO ",args:[],details:{count:a_startArgCounter}};this._buildFrom(result,a_query.from),result.query+=" (";for(var isFirst=!0,i=0;i<a_query.values.length;++i)result.query+=isFirst?" ":", ",this._buildSafeElement(result,a_query.values[i].field),isFirst=!1;result.query+=" ) VALUES (";for(isFirst=!0,i=0;i<a_query.values.length;++i)result.query+=isFirst?" ":", ",this._buildArg(result,a_query.values[i],!0),isFirst=!1;return result.query+=" )",fcf.empty(a_query.language)||(result.query+=" LANGUAGE "+a_query.language,a_query.defaultLanguage&&(result.query+=" DEFAULT ")),delete result.details,result},this._buildUpdate=function(a_query,a_startArgCounter){var result={query:"UPDATE ",args:[],details:{count:a_startArgCounter}};if(this._buildFrom(result,a_query.from),Array.isArray(a_query.join))for(var i=0;i<a_query.join.length;++i){var join=a_query.join[i];result.query+="string"==typeof join.join&&"left"==join.join.toLowerCase()?" LEFT JOIN ":"string"==typeof join.join&&"right"==join.join.toLowerCase()?" RIGHT JOIN ":" JOIN ",this._buildSafeElement(result,join.from),fcf.empty(join.as)||(result.query+=" AS ",this._buildSafeElement(result,join.as)),result.query+=" ON",this._buildWhere(result,join.on,!0)}result.query+=" SET";var isFirst=!0;for(i=0;i<a_query.values.length;++i)result.query+=isFirst?" ":", ",this._buildSafeElement(result,a_query.values[i].field),result.query+=" = ",this._buildArg(result,a_query.values[i],!0),isFirst=!1;return this._buildWhere(result,a_query.where),fcf.empty(a_query.language)||(result.query+=" LANGUAGE "+a_query.language,a_query.defaultLanguage&&(result.query+=" DEFAULT ")),delete result.details,result},this._buildDelete=function(a_query,a_startArgCounter){var result={query:"DELETE FROM ",args:[],details:{count:a_startArgCounter}};return this._buildFrom(result,a_query.from),this._buildWhere(result,a_query.where),fcf.empty(a_query.language)||(result.query+=" LANGUAGE "+a_query.language),delete result.details,result},this._buildWhere=function(a_result,a_where,a_isNotRoot){if(!fcf.empty(a_where)){var startLength=a_result.query.length,isEmpty=!0;a_isNotRoot||(a_result.query+=" WHERE");for(var i=0;i<a_where.length;++i){if(0!==i){var logic=a_where[i].logic?a_where[i].logic.toUpperCase():"AND";a_result.query+=" "+logic}a_where[i].not&&(a_result.query+=" NOT");var type=a_where[i].type;"true"==type?(a_result.query+=" TRUE ",isEmpty=!1):"false"==type?(a_result.query+=" FALSE ",isEmpty=!1):"block"!=type?(a_result.query+=" ",this._buildArg(a_result,a_where[i].args[0]),a_result.query+=" ",a_result.query+=type,a_result.query+=" ",this._buildArg(a_result,a_where[i].args[1]),isEmpty=!1):fcf.empty(a_where[i].args)||(a_result.query+=" (",this._buildWhere(a_result,a_where[i].args,!0),a_result.query+=" )",isEmpty=!1)}isEmpty&&(a_result.query=a_result.query.substr(0,startLength))}},this._buildSafeElement=function(a_result,a_elem){a_elem=fcf.replaceAll(a_elem,'"','\\"'),a_result.query+='"'+a_elem+'"'},this._buildFrom=function(a_result,a_from){this._buildSafeElement(a_result,a_from)},this._buildArgResult=function(a_result,a_fieldInfo){this._buildArg(a_result,a_fieldInfo),fcf.empty(a_fieldInfo.as)||(a_result.query+=" AS ",this._buildSafeElement(a_result,a_fieldInfo.as))},this._buildField=function(a_result,a_fieldInfo){a_fieldInfo.from&&(this._buildSafeElement(a_result,a_fieldInfo.from),a_result.query+="."),"*"==a_fieldInfo.field?a_result.query+="*":this._buildSafeElement(a_result,a_fieldInfo.field),a_fieldInfo.mode&&(a_result.query+=":",a_result.query+=a_fieldInfo.mode),fcf.each(a_fieldInfo.path,function(a_key,a_value){a_result.query+='->"',a_result.query+=fcf.escapeQuotes(a_value),a_result.query+='"'})},this._buildValue=function(a_result,a_value){a_result.args.push(a_value),a_result.query+="${"+ ++a_result.details.count+"}"},this._buildResult=function(a_result,a_arg){a_result.query+="$["+a_arg.result+"]["+a_arg.record+']["'+a_arg.item+'"]'},this._buildArg=function(a_result,a_arg,a_isNotField){if(!a_isNotField&&"field"in a_arg)this._buildField(a_result,a_arg);else if("function"in a_arg){if(this._buildSafeElement(a_result,a_arg.function),a_result.query+="(",Array.isArray(a_arg.args))for(var i=0;i<a_arg.args.length;++i)this._buildArg(a_result,a_arg.args[i],a_isNotField);a_result.query+=")"}else"value"in a_arg?this._buildValue(a_result,a_arg.value):"result"in a_arg&&this._buildResult(a_result,a_arg)}},NDetails.SingleBuilder}}),fcf.module({name:"fcf:NFSQL/Builder.js",dependencies:["fcf:NFSQL/NDetails/SingleBuilder.js"],module:function(SingleBuilder){var NFSQL=fcf.prepareObject(fcf,"NFSQL");return NFSQL.Builder=function(){this._builder=new SingleBuilder,this.build=function(a_queryObjects){var result={query:"",args:[]};a_queryObjects=Array.isArray(a_queryObjects)?a_queryObjects:[a_queryObjects];for(var i=0;i<a_queryObjects.length;++i){var resItem=this._builder.build(a_queryObjects[i],result.args.length);0!=i&&(result.query+="; "),result.query+=resItem.query,fcf.append(result.args,resItem.args)}return result}},NFSQL.Builder}}),fcf.module({name:"fcf:NFSQL/NDetails/ClientStorage.js",dependencies:["fcf:NFSQL/Builder.js"],module:function(Builder){var NDetails=fcf.prepareObject(fcf,"NFSQL.NDetails");return NDetails.ClientStorage=function(a_options){this._builder=new Builder,this.query=function(a_options,a_cb){var query=a_options.query,args=a_options.args?a_options.args:[];try{if("object"==typeof query){var txtQuery=this._builder.build(query);query=txtQuery.query,args=txtQuery.args}}catch(e){return void a_cb(e)}var url=fcf.application.getSettings().FSQLPath?fcf.application.getSettings().FSQLPath:"@url:fcfFSQL";url=fcf.buildUrl(url,{query:query}),fcf.loadObject({path:url,post:{args:args},onResult:function(a_error,a_response){a_cb(a_error,a_response)}})},this.destroy=function(){}},NDetails.ClientStorage}}),fcf.module({name:"fcf:NFSQL/Storage.js",dependencies:[fcf.isServer()?"fcf:NFSQL/NDetails/ServerStorage.js":"fcf:NFSQL/NDetails/ClientStorage.js"],module:function(ImplStorage){var NFSQL=fcf.prepareObject(fcf,"NFSQL");return NFSQL.Storage=function(a_options){var self=this;this._storage=new ImplStorage(a_options),this._projections=a_options.projections,this.query=function(a_options,a_cb){let args=arguments;return"object"==typeof a_options&&a_options.type||Array.isArray(a_options)?a_options={query:a_options}:"string"==typeof args[0]&&(a_options={query:a_options},Array.isArray(args[1])&&(a_options.args=args[1],a_cb=args[2])),fcf.actions().exec(function(a_act){self._storage.query(a_options,function(a_error,a_data){a_cb&&a_cb(a_error,a_data),a_error?void 0!==fcf.find(a_options.hideErrors,a_error.code)?a_act.complete([]):a_act.error(a_error):a_act.complete(a_data)})})},this.rawQuery=function(a_query,a_args,a_cb){return"function"==typeof a_args&&(a_cb=a_args,a_args=[]),fcf.actions().exec(a_act=>{self._storage.rawQuery(a_query,a_args,function(a_error,a_data){a_cb&&a_cb(a_error,a_data),a_error?a_act.error(a_error):a_act.complete(a_data)})})},this.destroy=function(){this._storage.destroy()},this.getStorage=function(){return this._storage},this.getProjections=function(){return this._projections}},NFSQL.Storage}}),fcf.module({name:"fcf:NEvent/Error.js",dependencies:[],module:function(){var NEvent=fcf.prepareObject(fcf,"NEvent");return NEvent.Error=function(a_args,a_subEvent){fcf.Event.call(this,"error",a_args,a_subEvent),this.directionalСall=!1},NEvent.Error}}),fcf.module({name:"fcf:NServer/Configuration.js",dependencies:[],module:function(){var NServer=fcf.prepareObject(fcf,"NServer");return NServer.Configuration=function(){var self=this;this._configuration={aliases:{},views:{},html:{include:{}},inheritanceModes:{},filters:{},functions:{}},this.getConfiguration=function(){return this._configuration},this.get=function(a_part){return this._configuration[a_part]},this.appendPackageInfo=function(a_name,a_data,a_isTheme){if("object"==typeof a_data.aliases&&fcf.append(this._configuration.aliases,a_data.aliases),"object"==typeof a_data.views)for(var mask in a_data.views)mask in this._configuration.views||(this._configuration.views[mask]={}),fcf.append(this._configuration.views[mask],a_data.views[mask]);a_isTheme||"object"==typeof a_data.html&&"object"==typeof a_data.html.include&&fcf.append(this._configuration.html.include,a_data.html.include),"object"==typeof a_data.inheritanceModes&&fcf.append(this._configuration.inheritanceModes,a_data.inheritanceModes),"object"==typeof a_data.filters&&fcf.append(this._configuration.filters,a_data.filters),"object"==typeof a_data.functions&&fcf.append(this._configuration.fsqlFunctions,a_data.functions),"string"==typeof a_data.cacheDirectory&&(this._configuration.cacheDirectory=a_data.cacheDirectory),"string"==typeof a_data.directorySystemProjections&&(this._configuration.directorySystemProjections=a_data.directorySystemProjections),"string"==typeof a_data.fileDirectory&&(this._configuration.fileDirectory=a_data.fileDirectory),a_data.maxSizeReceived&&(this._configuration.maxSizeReceived=a_data.maxSizeReceived),a_data.maxUrlCountParametersReceived&&(this._configuration.maxUrlCountParametersReceived=a_data.maxUrlCountParametersReceived),"string"==typeof a_data.imageDirectory&&(this._configuration.imageDirectory=a_data.imageDirectory),"object"==typeof a_data.packages&&fcf.each(a_data.packages,function(a_key,a_value){self._configuration.packages||(self._configuration.packages={}),self._configuration.packages[a_key]||(self._configuration.packages[a_key]={}),fcf.append(self._configuration.packages[a_key],a_value)})}},NServer.Configuration}}),fcf.module({name:"fcf:NClient/LocalData.js",dependencies:[],debug:!0,module:function(){var NClient=fcf.prepareObject(fcf,"NClient");return NClient.LocalData=function(){var self=this;this._data={},this._dataKeys={},this._originData={},this._sources={},this._originSources={},this.setOriginData=function(a_origin){fcf.append(this._originData,a_origin)},this.setSourcesData=function(a_origin){for(var id in a_origin){var object={};for(var key in a_origin[id])object[fcf.normalizeObjectAddress(key)]=a_origin[id][key];this._sources[id]=object,id in this._originSources||(this._originSources[id]=fcf.append(!0,{},a_origin[id]))}},this.setOriginObject=function(a_objectId,a_data){this._originData[a_objectId]=a_data},this.setObject=function(a_objectId,a_data){this._data[a_objectId]=a_data},this.setSourceObject=function(a_objectId,a_data){this._sources[a_objectId]=a_data,a_objectId in this._originSources||(this._originSources[a_objectId]=fcf.append(!0,{},a_data))},this.setSourceItem=function(a_objectId,a_item,a_value){this._sources[a_objectId]||(this._sources[a_objectId]={});var na=fcf.normalizeObjectAddress(a_item);this._sources[a_objectId][na]=a_value,a_objectId in this._originSources||(this._originSources[a_objectId]=fcf.append(!0,{},this._sources[a_objectId]))},this.setOriginItem=function(a_objectId,a_item,a_value){this._originData[a_objectId]||(this._originData[a_objectId]={});var ptr=fcf.resolveEx(this._originData[a_objectId],a_item,!0);ptr.object[ptr.key]=a_value},this.setItem=function(a_objectId,a_item,a_value){for(var parts=fcf.parseObjectAddress(a_item),argName="",argSuffix="",source=void 0,i=0;i<parts.length;++i){argName="",argSuffix="";for(var size=parts.length-i,j=0;j<parts.length;++j)j<size?argName+='["'+parts[j]+'"]':argSuffix+='["'+parts[j]+'"]';if(void 0!==(source=fcf.application.getLocalData().getSourceItem(a_objectId,argName)))break}if(fcf.isArg(source)&&"reference"===source.type){var id=source.id;if(-1!==id.indexOf("@{{")||-1!==id.indexOf("${{")){var args=fcf.application.getLocalData().getObject(a_objectId);id=fcf.tokenize(id,{args:args})}var path=source.arg+argSuffix;if(-1!==path.indexOf("@{{")||-1!==path.indexOf("${{")){args=fcf.application.getLocalData().getObject(a_objectId);path=fcf.tokenize(path,{args:args})}return this.setItem(id,path,a_value)}if(this._data[a_objectId]||(this._data[a_objectId]={}),this._dataKeys[a_objectId]||(this._dataKeys[a_objectId]={}),argSuffix&&void 0===fcf.resolve(this._data[a_objectId],argName)){this._originData[a_objectId]||(this._originData[a_objectId]={});var orgPtr=fcf.resolveEx(this._originData[a_objectId],argName,!0),modPtr=fcf.resolveEx(this._data[a_objectId],argName,!0);modPtr.object[modPtr.key]=fcf.clone(orgPtr.object[orgPtr.key])}itemPtr=fcf.resolveEx(this._data[a_objectId],a_item,!0),itemPtr.object[itemPtr.key]=a_value;var normArgName=fcf.normalizeObjectAddress(argName);this._dataKeys[a_objectId][normArgName]=normArgName},this.removeObject=function(a_objectId){delete this._originData[a_objectId],delete this._data[a_objectId],delete this._sources[a_objectId],delete this._originSources[a_objectId]},this.getObject=function(a_objectId){var dataObject={};return fcf.append(dataObject,this._originData[a_objectId]),fcf.each(this._dataKeys[a_objectId],function(a_key){var dstPtr=fcf.resolveEx(dataObject,a_key,!0),dataPtr=fcf.resolveEx(self._data[a_objectId],a_key);dataPtr.object&&dataPtr.key in dataPtr.object&&(dstPtr.object[dataPtr.key]=dataPtr.object[dataPtr.key])}),dataObject},this.setModifyKeys=function(a_objectId,a_argKey){a_argKey=fcf.normalizeObjectAddress(a_argKey),this._dataKeys[a_objectId]||(this._dataKeys[a_objectId]={}),this._dataKeys[a_objectId][a_argKey]=a_argKey},this.getModifyKeys=function(a_objectId){return this._dataKeys[a_objectId]},this.clearModifyKeys=function(a_objectId){delete this._dataKeys[a_objectId]},this.getOriginObject=function(a_objectId){return this._originData[a_objectId]},this.getSourceObject=function(a_objectId){return this._sources[a_objectId]},this.getOriginSourceObject=function(a_objectId){return fcf.append(!0,{},this._originSources[a_objectId])},this.resetSources=function(){this._sources=fcf.append(!0,{},this._originSources)},this.cleanItem=function(a_objectId,a_item){if(this._data[a_objectId]){a_item=fcf.normalizeObjectAddress(a_item);var itemPtr=fcf.resolveEx(this._data[a_objectId],a_item);itemPtr.object&&void 0!==itemPtr.object[itemPtr.key]&&delete itemPtr.object[itemPtr.key],this._dataKeys[a_objectId]&&delete this._dataKeys[a_objectId][a_item]}},this.getItem=function(a_objectId,a_item){for(var parts=fcf.parseObjectAddress(a_item),argName="",argSuffix="",source=void 0,i=0;i<parts.length;++i){argName="",argSuffix="";for(var size=parts.length-i,j=0;j<parts.length;++j)j<size?argName+='["'+parts[j]+'"]':argSuffix+='["'+parts[j]+'"]';if(void 0!==(source=fcf.application.getLocalData().getSourceItem(a_objectId,argName)))break}if(fcf.isArg(source)&&"reference"===source.type){var id=source.id;if(-1!==id.indexOf("@{{")||-1!==id.indexOf("${{")){var args=fcf.application.getLocalData().getObject(a_objectId);id=fcf.tokenize(id,{args:args})}var path=source.arg+argSuffix;if(-1!==path.indexOf("@{{")||-1!==path.indexOf("${{")){args=fcf.application.getLocalData().getObject(a_objectId);path=fcf.tokenize(path,{args:args})}return this.getItem(id,path)}if(this._data[a_objectId]){var itemPtr;if(this._originData[a_objectId])(itemPtr=fcf.resolveEx(this._originData[a_objectId],a_item)).object&&void 0!==itemPtr.object[itemPtr.key]&&itemPtr.object[itemPtr.key];if((itemPtr=fcf.resolveEx(this._data[a_objectId],a_item)).object&&void 0!==itemPtr.object[itemPtr.key]){var val=itemPtr.object[itemPtr.key];return Array.isArray(val),val}}if(this._originData[a_objectId]&&((itemPtr=fcf.resolveEx(this._originData[a_objectId],a_item)).object&&void 0!==itemPtr.object[itemPtr.key]))return fcf.clone(itemPtr.object[itemPtr.key])},this.getSourceItem=function(a_objectId,a_item,a_usingDepth){if(a_objectId in this._sources)if(a_usingDepth)for(var parts=fcf.parseObjectAddress(a_item),i=0;i<parts.length;++i){for(var name="",size=parts.length-i,j=0;j<size;++j)name+='["'+parts[j]+'"]';if(this._sources[a_objectId][name])return this._sources[a_objectId][name];if(this._originSources[a_objectId]&&this._originSources[a_objectId][name])return this._originSources[a_objectId][name]}else{if(a_item=fcf.normalizeObjectAddress(a_item),this._sources[a_objectId][a_item])return this._sources[a_objectId][a_item];if(this._originSources[a_objectId]&&this._originSources[a_objectId][name])return this._originSources[a_objectId][name]}}},NClient.LocalData}}),fcf.module({name:"fcf:NClient/Router.js",dependencies:[],debug:!0,module:function(){var NClient=fcf.prepareObject(fcf,"NClient");return NClient.Router=function(){this._routeInfo=new fcf.RouteInfo({url:window.location.href}),this.setRoute=function(a_route){this._routeInfo.setRoute(a_route)},this.getRouteInfo=function(){return this._routeInfo},this.update=function(){this._routeInfo.update({url:window.location.href})},this.setArg=function(a_argName,a_value){this._routeInfo.args[a_argName]=a_value;var url=this._routeInfo.buildUrl();window.history.pushState(void 0,void 0,url)}},NClient.Router}}),fcf.module({name:"fcf:NClient/Application.js",dependencies:["fcf:NTheme/Themes.js","fcf:NTheme/Theme.js","fcf:NRender/Render.js","fcf:NFSQL/Projections.js","fcf:NFSQL/Storage.js","fcf:NEvent/Error.js","fcf:NServer/Configuration.js","fcf:NClient/LocalData.js","fcf:NClient/Router.js"],debug:!0,module:function(Themes,Theme,Render,Projections,Storage,Error,Configuration,LocalData,Router){var NClient=fcf.prepareObject(fcf,"NClient");return window.addEventListener("popstate",function(event){null!==event.state&&fcf.application.update()}),NClient.Application=function(){var self=this;if(this._configuration=new Configuration,this._themes=new Themes({},this._configuration),this._localData=new LocalData,this._router=new Router,this._lastURL=window.location.href,this._delayedUpdate=!1,this._projections=new Projections,fcf.NDetails._projections)for(var key in fcf.NDetails._projections)this._projections.appendProjectionStruct(fcf.NDetails._projections[key]);this._settings={route:window.location.href,"fileСaching":!0,clientRenderingMode:"client",defaultTheme:"defaultTheme",renderStorage:{},renderRestore:{}},this._eventChannel=new fcf.EventChannel({owner:this}),this._storage=new Storage({projections:this._projections,eventChannel:this._eventChannel}),this._render=new Render({application:this,storage:this._storage,"fileСaching":this._settings.fileСaching,routeInfo:this._router.getRouteInfo()}),this.render=function(a_options){return fcf.actions().exec(function(a_act){function clCompleteRender(a_error,a_template){if(a_error)return fcf.log.err("FCF",a_error.message,a_error),a_options.onResult&&a_options.onResult(a_error,a_template),void a_act.error(a_error);if(!a_options.update&&a_template.state&&a_template.state.args)for(var id in a_template.state.args){fcf.application.getLocalData().setOriginObject(id,a_template.state.args[id]),fcf.application.getLocalData().setObject(id,{});var wrp=fcf.getWrapper(id);if(wrp){var rwrp=new wrp.constructor(wrp.getInitializeOptions(),!0);for(var k in rwrp)"_id"!=k&&(wrp[k]=rwrp[k])}}if(a_template.state&&a_template.state.sources)for(var id in a_template.state.sources)fcf.application.getLocalData().setSourceObject(id,a_template.state.sources[id]);function clCreate(){if(!1!==a_options.owner)if(a_options.owner="string"==typeof a_options.owner?fcf.select(a_options.owner)[0]:void 0===a_options.owner?document.body:a_options.owner,a_template.args.fcfWrapper){(div=document.createElement("div")).innerHTML=a_template.content,a_template.domElement=div.firstChild,a_template.domElements=[a_template.domElement],a_options.owner&&a_options.owner.appendChild(a_template.domElement)}else{var div;(div=document.createElement("div")).innerHTML=a_template.content,a_template.domElements=[];for(var i=0;i<div.children.length;++i){var el=div.children[i];a_template.domElements.push(el),a_options.owner&&a_options.owner.appendChild(el)}}(void 0===a_options.wrapper||a_options.wrapper)&&a_template.args.fcfWrapper?fcf.liven(a_template.domElement,function(){a_template.wrapper=fcf.NDetails._wrappers[a_template.id],a_options.onResult&&a_options.onResult(a_error,a_template),a_act.complete(a_template)}):(a_options.onResult&&a_options.onResult(a_error,a_template),a_act.complete(a_template))}Array.isArray(a_template.args.fcfInclude)?fcf.include(a_template.args.fcfInclude,clCreate):clCreate()}"server"==(a_options.renderMode?"server"==a_options.renderMode?"server":"client":fcf.application.getSettings().clientRenderingMode)?fcf.loadObject({path:"@url:fcfRender",post:{template:a_options.template,args:a_options.args,url:window.location.href,externalArgs:a_options.externalArgs},onResult:function(a_error,a_response){clCompleteRender(a_error,a_response)}}):self.getRender().render({template:a_options.template,args:a_options.args,theme:a_options.theme,update:a_options.update,content:fcf.getContext(),externalArgs:a_options.externalArgs,onResult:function(a_error,a_template){a_error&&"ERROR_RENDER_SERVER_ONLY_TEMPLATE"==a_error.name?fcf.loadObject({path:"@url:fcfRender",post:{template:a_options.template,args:a_options.args,url:window.location.href},onResult:function(a_error,a_response){clCompleteRender(a_error,a_response)}}):clCompleteRender(a_error,a_template)}})}).catch(a_error=>{fcf.application.getEventChannel().send("error",{error:a_error})})},this.getSettings=function(){return this._settings.defaultTheme=this._themes.getDefaultThemeName(),this._settings},this.setSettings=function(a_options){return"string"==typeof a_options&&(a_options=fcf.lz.decompressFromBase64(a_options),a_options=eval("("+a_options+")")),a_options.defaultTheme&&(this._themes.setDefaultThemeName(a_options.defaultTheme),this._settings.defaultTheme=a_options.defaultTheme),a_options.renderStorage&&this._localData.setOriginData(a_options.renderStorage),a_options.renderRestore&&this._localData.setSourcesData(a_options.renderRestore),a_options.clientRenderingMode&&(this._settings.clientRenderingMode="server"==a_options.clientRenderingMode?"server":"client"),void 0!==a_options.fileСaching&&(this._settings.fileСaching=!!a_options.fileСaching,this._render.setFileСaching(!!a_options.fileСaching)),void 0!==a_options.route&&this._router.setRoute(a_options.route),void 0!==a_options.context&&fcf.setContext(new fcf.Context(a_options.context)),this},this.selectSystemVariables=function(a_variables,a_options,a_cb){"function"==typeof a_options&&(a_cb=a_options,a_options={}),a_options||(a_options={});var result={};a_variables=Array.isArray(a_variables)?a_variables:[a_variables];for(var query={type:"select",from:"fcf_variables",fields:[{field:"value"},{field:"name"},{field:"package"}],where:[]},i=0;i<a_variables.length;++i){result[a_variables[i]]=null;var pos=a_variables[i].indexOf(":"),pack=-1!=pos?a_variables[i].substr(0,pos):"",name=-1!=pos?a_variables[i].substr(pos+1):a_variables[i];query.where.push({logic:"or",type:"block",args:[{logic:"and",type:"=",args:[{field:"package"},{value:pack}]},{logic:"and",type:"=",args:[{field:"name"},{value:name}]}]})}var queryOptions=fcf.append({},a_options,{query:query});return self.getStorage().query(queryOptions).then(function(a_data){for(var i=0;i<a_data[0].length;++i)result[a_data[0][i].package+":"+a_data[0][i].name]=fcf.strToObject(a_data[0][i].value);return a_cb&&a_cb(void 0,result),result}).catch(function(a_error){a_cb(a_error)})},this.selectSystemVariable=function(a_variable,a_options,a_cb){"function"==typeof a_options&&(a_cb=a_options,a_options={}),a_options||(a_options={});var result=void 0,pos=a_variable.indexOf(":"),query={type:"select",from:"fcf_variables",fields:[{field:"value"},{field:"name"},{field:"package"}],where:[{logic:"and",type:"=",args:[{field:"package"},{value:-1!=pos?a_variable.substr(0,pos):""}]},{logic:"and",type:"=",args:[{field:"name"},{value:-1!=pos?a_variable.substr(pos+1):a_variable}]}]},queryOptions=fcf.append({},a_options,{query:query});return fcf.actions().exec(function(a_act){self.getStorage().query(queryOptions,function(a_error,a_data){if(a_error)return a_cb(a_error,result),void a_act.error(a_error);a_data[0].length&&(result=fcf.strToObject(a_data[0][0].value)),a_cb&&a_cb(void 0,result),a_act.complete(result)})})},this.updateSystemVariables=function(a_objectVariables,a_options,a_cb){"function"==typeof a_options&&(a_options,a_options={}),a_options||(a_options={});var queries=[];for(var varName in a_objectVariables){var query={type:"update",from:"fcf_variables",values:[],where:[]},pos=varName.indexOf(":"),pack=-1!=pos?varName.substr(0,pos):"",name=-1!=pos?varName.substr(pos+1):varName;query.values.push({field:"value",value:JSON.stringify(a_objectVariables[varName])}),query.where.push({logic:"or",type:"block",args:[{logic:"and",type:"=",args:[{field:"package"},{value:pack}]},{logic:"and",type:"=",args:[{field:"name"},{value:name}]}]}),queries.push(query)}var queryOptions=fcf.append({},a_options,{query:queries});return self.getStorage().query(queryOptions)},this.getRouter=function(){return this._router.update(),this._router},this.getThemes=function(){return this._themes},this.getStorage=function(){return this._storage},this.getProjections=function(){return this._projections},this.getRender=function(){return this._render},this.getEventChannel=function(){return this._eventChannel},this.getConfiguration=function(){return this._configuration},this.appendPackages=function(a_packageNames){if(Array.isArray(a_packageNames))for(var i=0;i<a_packageNames.length;++i)this.appendPackage(a_packageNames[i])},this.appendPackage=function(a_packageName){var path="/fcfpackages/"+a_packageName+"/"+a_packageName+".package";fcf.load({path:path,async:!1,onResult:function(a_error,a_data){if(a_error)fcf.log.err("FCF",a_error.message,a_error);else{var info=fcf.scriptExecutor.parse(a_data,{},path,0);self._configuration.appendPackageInfo(a_packageName,info)}}})},this.appendPackageRawObject=function(a_packageName,a_packageObject){self._configuration.appendPackageInfo(a_packageName,a_packageObject)},this.appendThemes=function(a_themeNames){if(Array.isArray(a_themeNames))for(var i=0;i<a_themeNames.length;++i)this.appendTheme(a_themeNames[i])},this.appendTheme=function(a_themeName){var path="/fcfpackages/"+a_themeName+"/"+a_themeName+".theme";fcf.load({path:path,async:!1,onResult:function(a_error,a_data){if(a_error)fcf.log.err("FCF",a_error.message,a_error);else{var info=fcf.scriptExecutor.parse(a_data,{},path,0),theme=new Theme({package:a_themeName,info:info,configuration:self._configuration});fcf.actions(theme.initialize()).then(function(){self._themes.attachTheme(a_themeName,theme)})}}})},this.appendThemeRawObject=function(a_themeName,a_object){var theme=new Theme({package:a_themeName,info:a_object,configuration:self._configuration});fcf.actions(theme.initialize()).then(function(){self._themes.attachTheme(a_themeName,theme)})},this.getLocalData=function(){return this._localData},this.getInheritanceModes=function(){return this._configuration.getConfiguration().inheritanceModes},this.delayedUpdate=function(){this._delayedUpdate||(this._delayedUpdate=!0,setTimeout(function clDelayedUpdate(){self._lastURL!=window.location.href?(self._lastURL=window.location.href,setTimeout(clDelayedUpdate,0)):(self._delayedUpdate=!1,self.update())},0))},this.delayedReload=function(){setTimeout(function clDelayedUpdate(){self._lastURL!=window.location.href?(self._lastURL=window.location.href,setTimeout(clDelayedUpdate,0)):window.location.reload(!1)},0)},this.update=function(){function clUpdateWrapper(a_id){var wrapper=fcf.NDetails._wrappers[a_id],originArgs=self.getLocalData().getSourceObject(a_id),needUpdate=!1;for(var key in originArgs){var originItem=originArgs[key];fcf.isArg(originItem)&&originItem.followRoute&&(wrapper.cleanTemplateData(key),needUpdate=!0)}return needUpdate&&wrapper.refresh(),needUpdate}function clEachProcess(a_wrapper){for(var childs=a_wrapper.getChilds(),i=0;i<childs.length;++i)clUpdateWrapper(childs[i].getId())||clEachProcess(childs[i])}this.getRouter().getRouteInfo().update({url:window.location.href});for(var rootElements=fcf.select(":not([fcfparent])[fcftemplate]"),i=0;i<rootElements.length;++i){var wrapper=fcf.getWrapper(rootElements[i]);if(!wrapper)return;clUpdateWrapper(wrapper.getId())||clEachProcess(wrapper)}}},fcf.NClient.application=new NClient.Application,fcf.application=fcf.NClient.application,fcf.NClient.application}}),fcf.module({name:"fcf:NRender/Wrapper.js",module:function(){var NRender=fcf.prepareObject(fcf,"NRender"),stUpdatableWrappers={},stUpdateCounter=0;function stUpdateWrapper(a_info){var updateCounterLast=++stUpdateCounter;stUpdatableWrappers[a_info.id]=a_info,setTimeout(function clUpdate(){if(updateCounterLast!=stUpdateCounter)return updateCounterLast=stUpdateCounter,void setTimeout(clUpdate,1);var wrappers=stUpdatableWrappers;stUpdatableWrappers={};var rm={};function clFilter(a_wrapper){var chlids=a_wrapper.getChilds();for(var k in chlids){var id=chlids[k].getId();id in wrappers&&(rm[id]=!0),clFilter(chlids[k])}}for(var id in wrappers){var wrapper=fcf.getWrapper(id);wrapper?clFilter(wrapper):rm[id]=!0}for(var id in rm)delete wrappers[id];function clFillExternalRef(a_dst,a_rootId,a_id){let srcArgs=fcf.application.getLocalData().getSourceObject(a_id);if(srcArgs)for(let key in srcArgs){if(!fcf.isArg(srcArgs[key])||"reference"!==srcArgs[key].type)continue;let objectValues=fcf.application.getLocalData().getObject(a_id),parentWrapper=fcf.getWrapper(a_id).getParent(),refParentObjectValues=parentWrapper?fcf.application.getLocalData().getObject(parentWrapper.getId()):void 0,refId=fcf.tokenize(srcArgs[key].id,{args:objectValues,parent:refParentObjectValues}),refArg=fcf.tokenize(srcArgs[key].arg,{args:objectValues,parent:refParentObjectValues});if(0!=fcf.getWrapper(a_rootId).select("[id="+refId+"]").length)continue;a_dst[refId]||(a_dst[refId]={});let refObjectValues=fcf.application.getLocalData().getObject(refId),refData=fcf.resolveEx(refObjectValues,refArg),refDst=fcf.resolveEx(a_dst[refId],refArg,!0);void 0==refData.object?refDst.object[refDst.key]=void 0:refDst.object[refDst.key]=refData.object[refData.key]}}updateCounterLast=0,fcf.each(wrappers,function(rootId,info){let externalRefValues={};if(info.restoreState){var modifyChildArgs={childs:{},args:{}};(wrapper=fcf.getWrapper(rootId))&&(clFillExternalRef(externalRefValues,rootId,rootId),wrapper.getChilds(),function clFillChilds(a_wrapper,a_modifyChildArgs){var fcfSaveChildsState=a_wrapper.getArg("fcfSaveChildsState");void 0===fcfSaveChildsState&&(fcfSaveChildsState=!0),0!=fcfSaveChildsState&&fcf.each(a_wrapper.getChilds(),function(a_key,a_child){var fcfCallPosition=a_child.getArg("fcfCP"),id=a_child.getId(),modifyKeys=fcf.application.getLocalData().getModifyKeys(id),args={};clFillExternalRef(externalRefValues,rootId,id);var sources=fcf.application.getLocalData().getSourceObject(id);for(var key in sources)modifyKeys&&key in modifyKeys&&(args[key]=sources[key]);for(var key in modifyKeys){var srcArg=fcf.append({},fcf.application.getLocalData().getSourceObject(id));fcf.isArg(srcArg[key])&&"reference"==srcArg[key].type||fcf.isArg(srcArg[key])&&"programmable"!=srcArg[key].type&&srcArg[key].important||(args[key]=a_child.getArg(key))}args['["fcfId"]']=a_child.getId();var fcfevntid=a_child.getDomElement().getAttribute("fcfevntid");fcfevntid&&(args['["fcfEvntid"]']=fcfevntid),a_modifyChildArgs.childs[fcfCallPosition]={childs:{},args:args},clFillChilds(a_child,a_modifyChildArgs.childs[fcfCallPosition])})}(wrapper,modifyChildArgs),info.args.fcfChildsArgs=modifyChildArgs)}else{var wrapper;(wrapper=fcf.getWrapper(rootId))&&(clFillExternalRef(externalRefValues,rootId,(a_wrapper=wrapper).getId()),fcf.each(a_wrapper.getChilds(),(a_key,a_child)=>{clFillExternalRef(externalRefValues,rootId,a_child.getId())}))}var a_wrapper;fcf.application.render({template:info.template,theme:info.theme,owner:!1,args:info.args,update:info.update,wrapper:info.wrapper,externalArgs:externalRefValues,onResult:function(a_error,a_template){info.cb(a_error,a_template,!0)}})})},0)}var stReferences={};function stAttachReferences(a_wrapper){var id=a_wrapper.getId(),srcArgs=fcf.application.getLocalData().getSourceObject(id);for(name in srcArgs){var arg=srcArgs[name];if(fcf.isArg(arg)&&"reference"==arg.type){-1===arg.id.indexOf("${{")&&-1===arg.id.indexOf("@{{")&&-1===arg.arg.indexOf("${{")&&-1===arg.arg.indexOf("@{{")||(arg=fcf.tokenize(arg,{args:fcf.application.getLocalData().getObject(a_wrapper._id),route:fcf.getContext().get("route")}));var argPath=fcf.normalizeObjectAddress(arg.arg),argName=fcf.normalizeObjectAddress(fcf.parseObjectAddress(arg.arg)[0]);stReferences[arg.id]||(stReferences[arg.id]={}),stReferences[arg.id][argName]||(stReferences[arg.id][argName]={}),stReferences[arg.id][argName][id]||(stReferences[arg.id][argName][id]={}),stReferences[arg.id][argName][id][name]=argPath}}}class Wrapper{constructor(a_initializeOptions,a_ignoreReg){this._id=a_initializeOptions.domElement.getAttribute("id"),this._setArgRecursion=!1,this._initializeOptions=a_initializeOptions,this._callPositionsSetArg={},a_ignoreReg||(fcf.NDetails._wrappers[this._id]=this)}initialize(){let self=this;fcf.liven(void 0,this._id,function(a_error){a_error?this._initializeOptions.onReady&&this._initializeOptions.onReady(a_error,self):self._initialize(function(a_error){a_error?this._initializeOptions.onReady&&this._initializeOptions.onReady(a_error,self):(self._attachInnerEvents(),self._attach(function(a_error){a_error?this._initializeOptions.onReady&&this._initializeOptions.onReady(a_error,self):(stAttachReferences(self),self._initializeOptions.onReady&&self._initializeOptions.onReady(a_error,self))}))})})}reattach(a_cb){let self=this;fcf.liven(void 0,this._id,function(a_error){self._attachInnerEvents(),self._attach(function(a_error){a_cb(a_error,self)})})}getInitializeOptions(){return this._initializeOptions}update(a_cb){let self=this;if(this.getDomElement()){var alias=this.getDomElement().getAttribute("fcfalias"),template=this.getDomElement().getAttribute("fcftemplate"),parentId=this.getDomElement().getAttribute("fcfparent");null===parentId&&(parentId=void 0);var id=this.getDomElement().getAttribute("id"),args=fcf.append({},fcf.application.getLocalData().getSourceObject(id));fcf.each(fcf.application.getLocalData().getModifyKeys(id),function(a_key){var ptr=fcf.resolveEx(args,a_key,!0);ptr.object[fcf.normalizeObjectAddress(ptr.key)]=fcf.application.getLocalData().getItem(id,a_key)}),fcf.empty(alias)||(args.fcfAlias=alias),args.fcfId=id,args.fcfParent=parentId,this.getDomElement().getAttribute("fcfevntid")&&(args.fcfEvntid=this.getDomElement().getAttribute("fcfevntid")),stUpdateWrapper({id:this.getId(),template:template,theme:this.getThemeName(),args:args,update:!0,restoreState:!0,wrapper:!1,cb:function(a_error,a_template,a_rootCallback){if(a_rootCallback){if(a_template.state&&a_template.state.args)for(var id in a_template.state.args)fcf.application.getLocalData().setOriginObject(id,a_template.state.args[id]),fcf.application.getLocalData().setObject(id,{});if(a_template.state&&a_template.state.sources)for(var id in a_template.state.sources)fcf.application.getLocalData().setSourceObject(id,a_template.state.sources[id]);var domElement=self.getDomElement();domElement?(domElement.outerHTML=a_template.content,fcf.liven(domElement,a_cb)):a_cb&&a_cb(void 0,self)}}})}else a_cb&&a_cb()}refresh(a_cb){let self=this;if(this.getDomElement()){var alias=this.getDomElement().getAttribute("fcfalias"),template=this.getDomElement().getAttribute("fcftemplate"),parentId=this.getDomElement().getAttribute("fcfparent");null===parentId&&(parentId=void 0);var id=this.getDomElement().getAttribute("id"),args=fcf.application.getLocalData().getOriginSourceObject(id);fcf.empty(alias)||(args.fcfAlias=alias),args.fcfId=id,args.fcfParent=parentId,stUpdateWrapper({id:this.getId(),template:template,theme:this.getThemeName(),args:args,update:!0,restoreState:!1,wrapper:!1,cb:function(a_error,a_template,a_rootCallback){if(a_rootCallback){if(a_template.state&&a_template.state.args)for(var id in a_template.state.args){fcf.application.getLocalData().setOriginObject(id,a_template.state.args[id]),fcf.application.getLocalData().setObject(id,{}),fcf.application.getLocalData().resetSources(),fcf.application.getLocalData().clearModifyKeys(id);var wrp=fcf.getWrapper(id);if(wrp){var rwrp=new wrp.constructor(wrp.getInitializeOptions(),!0);for(var k in rwrp)"_id"!=k&&(wrp[k]=rwrp[k])}}if(a_template.state&&a_template.state.sources)for(var id in a_template.state.sources)fcf.application.getLocalData().setSourceObject(id,a_template.state.sources[id]);var element=self.getDomElement();element.outerHTML=a_template.content,fcf.liven(element,a_cb)}}})}else a_cb&&a_cb()}save(){this.setArg("data",this.getData())}destroy(){"function"==typeof this.onDestroy&&this.onDestroy(),this.getDomElement().parentElement.removeChild(this.getDomElement()),delete stReferences[this.getId()],delete fcf.NDetails._wrappers[this.getId()]}render(a_options){var args={'["fcfParent"]':this.getId()};if("object"==typeof a_options.args)for(var key in a_options.args)args[fcf.normalizeObjectAddress(key)]=a_options.args[key];var template="+"==a_options.template.charAt(0)?this.getDomElement().getAttribute("fcftemplate")+a_options.template:a_options.template;fcf.application.render({template:template,owner:a_options.owner,args:args,onResult:function(a_error,a_template){a_options.onResult&&a_options.onResult(a_error,a_template)}})}getEventChannel(){return this._initializeOptions.eventChannel}emit(a_event,a_exData){if("string"==typeof a_event){let event=document.createEvent("Event");event.initEvent(a_event,!0,!0),event.name=a_event,event.type||(event.type=a_event),a_event=event}return a_exData&&fcf.append(a_event,a_exData),fcf.emitDomEvent(this.getActionDomElement(),a_event),a_event}send(a_data,a_inputFiles,a_cb){let self=this;return fcf.actions().exec(a_act=>{const formData=new FormData;formData.append("data",JSON.stringify(a_data)),formData.append("_fcfContext",JSON.stringify(fcf.getContext()));var filesAttributes=[],counter=0;fcf.each(a_inputFiles,function(k,input){if(input.files)for(var i=0;i<input.files.length;++i){formData.append("files["+counter+++"]",input.files[i]);var attributes={};fcf.each(input.attributes,function(k,attr){attributes[attr.name]=attr.value}),filesAttributes.push(attributes)}}),formData.append("filesAttributes",JSON.stringify(filesAttributes)),fcf.load({path:"@url:fcfReceive?template="+encodeURIComponent(self.getTemplate()),post:formData,onResult:function(a_error,a_response){a_cb&&a_cb(a_error,a_response),a_error?(fcf.application.getEventChannel().send("error",{error:a_error}),a_act.error(a_error)):a_act.complete(a_response)}})})}getTemplate(){return this.getDomElement().getAttribute("fcftemplate")}getId(){return this._id}getAlias(){return this.getDomElement().getAttribute("fcfalias")}getDomElement(){return document.getElementById(this._id)}getActionDomElement(){return this.getDomElement()}getParent(){if(this.getDomElement()){var parentId=this.getDomElement().getAttribute("fcfparent");if(!fcf.empty(parentId))return fcf.getWrapper(parentId)}}getChilds(){for(var domChilds=fcf.select(document.getElementById(this._id),"[fcfparent="+this._id+"]"),result=[],i=0;i<domChilds.length;++i){var wrapper=fcf.NDetails._wrappers[domChilds[i].getAttribute("id")];wrapper&&result.push(wrapper)}return result}getFirstChild(){for(var domChilds=fcf.select(document.getElementById(this._id),"[fcfparent="+this._id+"]"),i=0;i<domChilds.length;++i){return fcf.NDetails._wrappers[domChilds[i].getAttribute("id")]}}getChild(a_alias){var domChild=fcf.first(fcf.select(document.body,'[fcfparent="'+this._id+'"][fcfalias="'+fcf.encodeHtml(a_alias)+'"]'));if(domChild)return fcf.NDetails._wrappers[domChild.getAttribute("id")]}select(a_selector){return fcf.select("[id="+this.getId()+"] "+a_selector)}getWidthPx(){return document.getElementById(this.getId()).offsetWidth}getHeightPx(){return document.getElementById(this.getId()).offsetHeight}getLeftPx(){return this.getDomElement().getBoundingClientRect().left-document.body.getBoundingClientRect().left}getTopPx(){return this.getDomElement().getBoundingClientRect().top-document.body.getBoundingClientRect().top}addDomListener(a_eventName,a_func){var element=this.getActionDomElement();element&&fcf.addDomListener(element,a_eventName,a_func)}addChildDomListener(a_alias,a_eventName,a_func){this.getChild(a_alias).addDomListener(a_eventName,function(a_event){a_func(a_event)})}cleanTemplateData(a_key){fcf.application.getLocalData().cleanItem(this._id,a_key)}getFollowRouteArgs(a_key){}getCurrentData(){return this.getActionDomElement().value}getData(){this.getArg('["value"]')}setData(a_value){this.setArg('["value"]',a_value)}getArg(a_key){var source=fcf.application.getLocalData().getSourceItem(this._id,a_key);if(fcf.isArg(source)&&"reference"===source.type){var args={args:fcf.application.getLocalData().getObject(this._id)};source=fcf.tokenize(source,args);var dataOwner=fcf.getWrapper(source.id);return source?dataOwner.getArg(source.arg):fcf.application.getLocalData().getItem(this._id,a_key)}return fcf.application.getLocalData().getItem(this._id,a_key)}getArgs(){return fcf.application.getLocalData().getObject(this._id)}setArg(a_key,a_value,a_ignoreCallbacks){let stack=(new Error).stack;if(void 0===stack)try{throw new Error}catch(e){stack=e.stack}let pos=stack.indexOf("\n",0);pos=stack.indexOf("\n",pos+1);let posEnd=stack.indexOf("\n",pos+1),callPosition=fcf.trim(stack.substr(pos,posEnd-pos));a_key=fcf.normalizeObjectAddress(a_key),this._setArg(a_key,a_value,a_ignoreCallbacks,callPosition)}_setArg(a_key,a_value,a_ignoreCallbacks,callPosition){if(callPosition in this._callPositionsSetArg)return;if(this._callPositionsSetArg[callPosition]=!0,fcf.application.getLocalData().setItem(this._id,a_key,a_value),a_ignoreCallbacks)return;let eventMap={},clProcessLink=(a_id,a_key,a_value,a_req,a_eventMap,a_protectDublicattes,a_isRoot,a_upDirection)=>{if(a_req[a_id+" -> "+(a_key=fcf.normalizeObjectAddress(a_key))])return;a_req[a_id+" -> "+a_key]=!0;let argInfo=((a_id,a_key)=>{let parts=fcf.parseObjectAddress(a_key),name="",suffix="",source=void 0;for(var i=0;i<parts.length;++i){name="";let size=parts.length-i;for(var j=0;j<size;++j)name+='["'+parts[j]+'"]';if(void 0!==(source=fcf.application.getLocalData().getSourceItem(a_id,name))){for(suffix="",j=size;j<parts.length;++j)suffix+='["'+parts[j]+'"]';break}}return fcf.isArg(source)&&"reference"==source.type&&(-1===source.id.indexOf("${{")&&-1===source.id.indexOf("@{{")&&-1===source.arg.indexOf("${{")&&-1===source.arg.indexOf("@{{")||(source=fcf.tokenize(source,{args:fcf.application.getLocalData().getObject(a_id),route:fcf.getContext().get("route")}))),{path:fcf.normalizeObjectAddress(a_key),arg:name,suffix:suffix,id:a_id,source:source,requestPath:""}})(a_id,a_key);if((!a_protectDublicattes[a_id+argInfo.arg]||a_protectDublicattes[a_id+argInfo.arg]<argInfo.suffix.length)&&(a_protectDublicattes[a_id+argInfo.arg]=argInfo.suffix.length,a_eventMap[a_id+"->"+a_key]={id:a_id,arg:argInfo.arg,suffix:argInfo.suffix,value:fcf.application.getLocalData().getItem(a_id,argInfo.arg)}),void 0!==argInfo.source&&(fcf.isArg(argInfo.source)&&"reference"==argInfo.source.type&&clProcessLink(argInfo.source.id,argInfo.source.arg+argInfo.suffix,a_value,a_req,a_eventMap,a_protectDublicattes,!1,!0),stReferences[a_id]&&stReferences[a_id][argInfo.arg])){let refsInfo=stReferences[a_id][argInfo.arg];for(let childId in refsInfo)for(let childArgPath in refsInfo[childId]){let refChlidsPath=refsInfo[childId][childArgPath];if(0==argInfo.path.indexOf(refChlidsPath)){var child=fcf.application.getLocalData().getSourceItem(childId,childArgPath);let childParts=fcf.parseObjectAddress(child.arg);childParts.shift();let ownerParts=fcf.parseObjectAddress(argInfo.suffix),newSuffixParts=[];for(let i=0;i<ownerParts.length;++i)i>=childParts.length&&newSuffixParts.push(ownerParts[i]);let newSuffix="";for(var i=0;i<newSuffixParts.length;++i)newSuffix+='["'+newSuffixParts[i]+'"]';let value=fcf.application.getLocalData().getItem(childId,childArgPath+newSuffix);clProcessLink(childId,childArgPath+newSuffix,value,a_req,a_eventMap,a_protectDublicattes,!1,!1)}}}};for(var i in this._setArgRecursion=!0,clProcessLink(this._id,a_key,a_value,{},eventMap,{},!0,!0),a_key=fcf.normalizeObjectAddress(a_key),eventMap){let id=eventMap[i].id,eventInfo=eventMap[i],wrp=fcf.getWrapper(id);if(!wrp)continue;try{wrp.onArg&&wrp.onArg(eventInfo.arg,eventInfo.value,eventInfo.suffix)}catch(e){fcf.error("Wrapper",e,!1)}let simpleArg="";for(let i=0;i<eventInfo.arg.length;++i)'"'!=eventInfo.arg[i]&&"["!=eventInfo.arg[i]&&"]"!=eventInfo.arg[i]&&(simpleArg+=eventInfo.arg[i]);let method="onArg"+simpleArg.charAt(0).toUpperCase()+simpleArg.slice(1);try{wrp[method]&&wrp[method](eventInfo.value,eventInfo.suffix)}catch(e){fcf.error("Wrapper",e,!1)}var originArg=fcf.application.getLocalData().getSourceItem(id,eventMap[i].arg);if(fcf.isArg(originArg)&&originArg.followRoute){if("reload"==originArg.followRoute||"soft"==originArg.followRoute||"set"==originArg.followRoute){let args=fcf.getRouteVariablesBySource(originArg);var value=this.getArg(a_key);for(i=0;i<args.length;++i)fcf.application.getRouter().setArg(args[i],value)}"reload"==originArg.followRoute?fcf.application.delayedReload():"soft"==originArg.followRoute&&fcf.application.delayedUpdate()}}this._setArgRecursion=!1,this._callPositionsSetArg={}}getChildArg(a_alias,a_argName){return this.getChild(a_alias).getData()}validate(){for(var resultErrors=[],childs=this.getChilds(),i=0;i<childs.length;++i){var suberrors=childs[i].validate();resultErrors=fcf.append(resultErrors,suberrors)}return resultErrors}showErrors(a_errors){for(var childs=this.getChilds(),i=0;i<childs.length;++i){for(var childId=childs[i].getId(),childErrors=[],j=0;j<a_errors.length;++j)void 0!==fcf.find(a_errors[j].id,childId)&&childErrors.push(a_errors[j]);fcf.empty(childErrors)||childs[i].showErrors(childErrors)}}_initialize(a_cb){a_cb()}_attach(a_cb){if("function"==typeof this.onAttach){let res=this.onAttach();res instanceof fcf.Actions?res.then(()=>{a_cb()}):a_cb()}else a_cb()}getThemeName(){return fcf.application.getThemes().getDefaultThemeName()}getTheme(){return fcf.application.getThemes().getTheme(this.getThemeName())}}return Wrapper.prototype._attachInnerEvents=function(){let self=this;function clAttach(a_element){let fcfEvents={};for(let i=0;i<a_element.attributes.length;++i)0==a_element.attributes[i].name.toLowerCase().indexOf("fcfevent")&&(fcfEvents[a_element.attributes[i].name.substr(8)]=a_element.attributes[i].value);for(let eventName in fcfEvents){let eventCode=fcfEvents[eventName],options={wrapper:self,parent:self.getParent()};!function(options,eventCode){fcf.addDomListener(a_element,eventName,function(event){with(options)return eval(eventCode)})}(options,eventCode)}for(var i=0;i<a_element.children.length;++i)if(!a_element.children[i].getAttribute("fcftemplate"))var r=clAttach(a_element.children[i])}clAttach(this.getDomElement());var templateData=this.getArgs();for(var key in templateData)if("string"==typeof key&&0===key.indexOf("fcfEvent")){var eventName=key.substr(8);eventName=eventName[0].toLowerCase()+eventName.substr(1);var eventCode=templateData[key],options={wrapper:self,parent:self.getParent()};!function(eventName,eventCode,options){self.addDomListener(eventName,function(event){with(options)return eval(eventCode);return __result})}(eventName,eventCode,options)}},NRender.Wrapper=Wrapper,NRender.Wrapper}});